<!-- Database Backup Management -->
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h2>{{header_title}}</h2>
            <p class="text-muted">Gestión de respaldos de base de datos</p>
        </div>
        <div class="admin-user-info">
            <span><i class="bi bi-person-circle"></i> {{current_user.full_name}}</span>
            <a href="/dashboard" class="btn btn-sm btn-neutral">
                <i class="bi bi-arrow-left"></i> Dashboard
            </a>
        </div>
    </div>

    <!-- Warning Alert -->
    <div class="alert alert-warning alert-icon-left" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <div>
            <strong>⚠️ {{translations.warning_restore}}</strong>
            <p>{{translations.restore_instructions}}</p>
        </div>
    </div>

    <!-- Backup Directory Info -->
    {{#is_writable}}
    <div class="alert alert-info alert-icon-left" role="alert">
        <i class="bi bi-info-circle-fill"></i>
        <div>
            <strong>Directorio de Respaldos</strong>
            <p><code>{{backup_dir}}</code></p>
            <p><small>Tamaño total: <strong>{{total_backup_size}}</strong></small></p>
        </div>
    </div>
    {{/is_writable}}

    {{^is_writable}}
    <div class="alert alert-danger alert-icon-left" role="alert">
        <i class="bi bi-exclamation-circle-fill"></i>
        <div>
            <strong>⚠️ {{translations.backup_dir_warning}}</strong>
            <p><code>{{backup_dir}}</code></p>
            <p><small>No se puede escribir en este directorio. Verifique los permisos.</small></p>
        </div>
    </div>
    {{/is_writable}}

    <!-- Create Backup Section -->
    <div class="section-card">
        <div class="section-header">
            <h3><i class="bi bi-cloud-arrow-down"></i> {{translations.create_backup}}</h3>
        </div>
        <div class="section-body">
            <p>Cree un nuevo respaldo de la base de datos. Esta operación puede tomar varios minutos según el tamaño de la base de datos.</p>
            <button class="btn btn-primary" id="createBackupBtn" {{^is_writable}}disabled{{/is_writable}}>
                <i class="bi bi-download"></i> Crear Nuevo Respaldo
            </button>
            <div id="createBackupProgress" class="progress-container" style="display: none; margin-top: 20px;">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p class="text-muted text-center" style="margin-top: 10px;">{{translations.creating_backup}}</p>
            </div>
            <div id="createBackupStatus" style="display: none; margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Backups List Section -->
    <div class="section-card">
        <div class="section-header">
            <h3><i class="bi bi-archive"></i> {{translations.backup_list}}</h3>
        </div>
        <div class="section-body">
            {{#has_backups}}
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>{{translations.filename}}</th>
                            <th>{{translations.size}}</th>
                            <th>{{translations.date}}</th>
                            <th>{{translations.actions}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#backups}}
                        <tr data-filename="{{filename}}">
                            <td>
                                <i class="bi bi-file-earmark-binary"></i>
                                <code>{{filename}}</code>
                            </td>
                            <td><strong>{{size_human}}</strong></td>
                            <td>
                                <small>{{created_at_formatted}}</small><br>
                                <span class="text-muted">{{created_at_date}}</span>
                            </td>
                            <td class="action-buttons">
                                <a href="/admin/backup/download/{{filename}}" class="btn btn-sm btn-info" title="{{translations.download}}">
                                    <i class="bi bi-cloud-download"></i> {{translations.download}}
                                </a>
                                <button class="btn btn-sm btn-danger delete-backup-btn" data-filename="{{filename}}" title="{{translations.delete}}">
                                    <i class="bi bi-trash"></i> {{translations.delete}}
                                </button>
                            </td>
                        </tr>
                        {{/backups}}
                    </tbody>
                </table>
            </div>
            {{/has_backups}}

            {{#no_backups}}
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>{{translations.no_backups_yet}}</p>
            </div>
            {{/no_backups}}
        </div>
    </div>

    <!-- Restore Instructions Section -->
    <div class="section-card">
        <div class="section-header">
            <h3><i class="bi bi-cloud-arrow-up"></i> Restaurar Respaldo</h3>
        </div>
        <div class="section-body">
            <div class="alert alert-warning" role="alert">
                <strong>⚠️ Advertencia de Seguridad:</strong> La restauración de respaldos es una operación peligrosa que requiere acceso a la línea de comandos del servidor.
            </div>

            <h5>Para restaurar un respaldo, use los siguientes comandos en el servidor:</h5>

            <div class="code-block">
                <h6>MySQL/MariaDB:</h6>
                <pre><code>mysql -u [usuario] -p [base_datos] < /var/backups/backup_YYYY-MM-DD_HHmmss.sql</code></pre>
            </div>

            <div class="code-block">
                <h6>PostgreSQL:</h6>
                <pre><code>psql -U [usuario] [base_datos] < /var/backups/backup_YYYY-MM-DD_HHmmss.sql</code></pre>
            </div>

            <div class="alert alert-info" role="alert">
                <strong>ℹ️ Nota:</strong> Se recomienda hacer una copia de seguridad del servidor antes de restaurar cualquier respaldo. Contáctese con el administrador del sistema si necesita ayuda.
            </div>
        </div>
    </div>
</div>

<style>
.section-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin: 20px 0;
    padding: 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.section-header {
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
    background: #f9f9f9;
}

.section-header h3 {
    margin: 0;
    color: #333;
    font-size: 18px;
}

.section-body {
    padding: 20px;
}

.code-block {
    background: #f5f5f5;
    border-left: 4px solid #1B9E88;
    padding: 15px;
    margin: 15px 0;
    border-radius: 4px;
}

.code-block h6 {
    margin: 0 0 10px 0;
    color: #1B9E88;
    font-weight: 600;
}

.code-block code {
    display: block;
    font-family: 'Courier New', monospace;
    color: #333;
    font-size: 13px;
    overflow-x: auto;
}

.code-block pre {
    margin: 0;
}

.action-buttons {
    white-space: nowrap;
}

.action-buttons .btn {
    margin: 0 5px;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #999;
}

.empty-state i {
    font-size: 48px;
    display: block;
    margin-bottom: 15px;
    color: #ddd;
}

.alert-icon-left {
    display: flex;
    gap: 15px;
}

.alert-icon-left i {
    flex-shrink: 0;
    font-size: 20px;
}

.alert-icon-left > div {
    flex: 1;
}

.alert-icon-left p {
    margin: 5px 0 0 0;
}

.progress-container {
    text-align: center;
}

.progress {
    height: 25px;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    background-color: #1B9E88;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Create backup button
    const createBackupBtn = document.getElementById('createBackupBtn');
    if (createBackupBtn) {
        createBackupBtn.addEventListener('click', function() {
            createBackup();
        });
    }

    // Delete backup buttons
    const deleteButtons = document.querySelectorAll('.delete-backup-btn');
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            deleteBackup(this.dataset.filename);
        });
    });
});

function createBackup() {
    const btn = document.getElementById('createBackupBtn');
    const progressDiv = document.getElementById('createBackupProgress');
    const statusDiv = document.getElementById('createBackupStatus');

    btn.disabled = true;
    progressDiv.style.display = 'block';
    statusDiv.style.display = 'none';

    fetch('/admin/backup/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        progressDiv.style.display = 'none';

        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success alert-icon-left"><i class="bi bi-check-circle-fill"></i><div><strong>✓ Respaldo Creado</strong><p>' + data.message + '</p><p><small>Archivo: <code>' + data.backup.filename + '</code> (' + data.backup.size + ')</small></p></div></div>';
            statusDiv.style.display = 'block';

            // Reload page after 3 seconds
            setTimeout(() => location.reload(), 3000);
        } else {
            statusDiv.innerHTML = '<div class="alert alert-danger alert-icon-left"><i class="bi bi-exclamation-circle-fill"></i><div><strong>✗ Error</strong><p>' + data.message + '</p></div></div>';
            statusDiv.style.display = 'block';
            btn.disabled = false;
        }
    })
    .catch(error => {
        progressDiv.style.display = 'none';
        statusDiv.innerHTML = '<div class="alert alert-danger alert-icon-left"><i class="bi bi-exclamation-circle-fill"></i><div><strong>✗ Error</strong><p>Error: ' + error.message + '</p></div></div>';
        statusDiv.style.display = 'block';
        btn.disabled = false;
    });
}

function deleteBackup(filename) {
    if (!confirm('¿Está seguro de que desea eliminar este respaldo?\n\n' + filename + '\n\nEsta acción no se puede deshacer.')) {
        return;
    }

    fetch('/admin/backup/delete/' + encodeURIComponent(filename), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove row from table
            const row = document.querySelector(`tr[data-filename="${filename}"]`);
            if (row) {
                row.style.opacity = '0.5';
                setTimeout(() => row.remove(), 300);
            }
            alert('Respaldo eliminado correctamente');
        } else {
            alert('Error al eliminar el respaldo: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}
</script>
