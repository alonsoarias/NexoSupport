<div class="settings-section">
    <h3><i class="bi bi-file-earmark-spreadsheet"></i> Carga Masiva de Usuarios</h3>

    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong>Formato CSV requerido:</strong> El archivo debe contener las columnas:
        <code>username, email, password, firstname, lastname</code>
        <br>
        Columnas opcionales: <code>phone, address, city, country, institution</code>
    </div>

    {{#upload_stats}}
    <div class="alert alert-secondary">
        <i class="bi bi-graph-up"></i>
        <strong>Estadísticas:</strong> {{total_uploads}} cargas realizadas
        {{#last_upload}}
        - Última carga: {{last_upload_formatted}}
        {{/last_upload}}
    </div>
    {{/upload_stats}}

    <!-- Step 1: Download Template -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-download"></i> Paso 1: Descargar Plantilla</h5>
        </div>
        <div class="card-body">
            <p>Descarga la plantilla CSV con el formato correcto y ejemplos de datos.</p>
            <a href="/admin/tool/uploaduser/index.php?action=download_template" class="btn btn-primary">
                <i class="bi bi-file-earmark-arrow-down"></i> Descargar Plantilla CSV
            </a>
        </div>
    </div>

    <!-- Step 2: Upload CSV -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-upload"></i> Paso 2: Cargar Archivo CSV</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="/admin/tool/uploaduser/index.php" enctype="multipart/form-data">
                <input type="hidden" name="action" value="upload">

                <div class="mb-3">
                    <label for="csv_file" class="form-label">Archivo CSV</label>
                    <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                    <div class="form-text">Tamaño máximo: 5MB</div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="update_existing" name="update_existing" value="1">
                        <label class="form-check-label" for="update_existing">
                            Actualizar usuarios existentes
                        </label>
                        <div class="form-text">Si el username ya existe, actualizar sus datos</div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="send_emails" name="send_emails" value="1">
                        <label class="form-check-label" for="send_emails">
                            Enviar emails de bienvenida
                        </label>
                        <div class="form-text">Enviar email a usuarios nuevos con sus credenciales</div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success">
                    <i class="bi bi-upload"></i> Cargar y Procesar CSV
                </button>
            </form>
        </div>
    </div>

    <!-- Results (if available) -->
    {{#results}}
    <div class="card {{#success}}border-success{{/success}}{{^success}}border-danger{{/success}}">
        <div class="card-header {{#success}}bg-success text-white{{/success}}{{^success}}bg-danger text-white{{/success}}">
            <h5 class="mb-0">
                <i class="bi {{#success}}bi-check-circle{{/success}}{{^success}}bi-x-circle{{/success}}"></i>
                Resultados del Procesamiento
            </h5>
        </div>
        <div class="card-body">
            <div class="row text-center mb-3">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value text-primary">{{stats.total}}</div>
                        <div class="stat-label">Total Procesados</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value text-success">{{stats.created}}</div>
                        <div class="stat-label">Creados</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value text-info">{{stats.updated}}</div>
                        <div class="stat-label">Actualizados</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value text-warning">{{stats.skipped}}</div>
                        <div class="stat-label">Omitidos</div>
                    </div>
                </div>
            </div>

            {{#stats.errors}}
            <div class="alert alert-danger">
                <h6><i class="bi bi-exclamation-triangle"></i> Errores Encontrados:</h6>
                <ul class="mb-0">
                    {{#errors}}
                    <li>{{.}}</li>
                    {{/errors}}
                </ul>
            </div>
            {{/stats.errors}}

            {{#success}}
            <div class="alert alert-success mb-0">
                <i class="bi bi-check-circle"></i>
                Carga completada exitosamente. {{stats.created}} usuarios creados{{#stats.updated}}, {{stats.updated}} actualizados{{/stats.updated}}.
            </div>
            {{/success}}
        </div>
    </div>
    {{/results}}
</div>

<!-- Instructions -->
<div class="settings-section">
    <h4><i class="bi bi-question-circle"></i> Instrucciones</h4>

    <div class="accordion" id="instructionsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#formatInstructions">
                    Formato del Archivo CSV
                </button>
            </h2>
            <div id="formatInstructions" class="accordion-collapse collapse show" data-bs-parent="#instructionsAccordion">
                <div class="accordion-body">
                    <p><strong>Columnas Requeridas:</strong></p>
                    <ul>
                        <li><code>username</code>: Nombre de usuario único (3-30 caracteres alfanuméricos)</li>
                        <li><code>email</code>: Dirección de email válida</li>
                        <li><code>password</code>: Contraseña (mínimo 8 caracteres)</li>
                        <li><code>firstname</code>: Nombre</li>
                        <li><code>lastname</code>: Apellido</li>
                    </ul>

                    <p><strong>Columnas Opcionales:</strong></p>
                    <ul>
                        <li><code>phone</code>: Teléfono</li>
                        <li><code>address</code>: Dirección</li>
                        <li><code>city</code>: Ciudad</li>
                        <li><code>country</code>: País</li>
                        <li><code>institution</code>: Institución</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#validationRules">
                    Reglas de Validación
                </button>
            </h2>
            <div id="validationRules" class="accordion-collapse collapse" data-bs-parent="#instructionsAccordion">
                <div class="accordion-body">
                    <ul>
                        <li>El username debe ser único en el sistema</li>
                        <li>El email debe tener formato válido</li>
                        <li>La contraseña debe tener al menos 8 caracteres</li>
                        <li>Todos los campos requeridos deben estar presentes</li>
                        <li>El archivo no debe exceder 5MB</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#securityNotes">
                    Notas de Seguridad
                </button>
            </h2>
            <div id="securityNotes" class="accordion-collapse collapse" data-bs-parent="#instructionsAccordion">
                <div class="accordion-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-shield-exclamation"></i>
                        <strong>Importante:</strong>
                        <ul class="mb-0">
                            <li>Las contraseñas se almacenan con bcrypt (cost 12)</li>
                            <li>Se recomienda que los usuarios cambien su contraseña en el primer login</li>
                            <li>El archivo CSV se elimina automáticamente después del procesamiento</li>
                            <li>Todas las acciones quedan registradas en el log de auditoría</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
