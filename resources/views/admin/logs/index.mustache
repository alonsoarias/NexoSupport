<!-- System Logs Viewer -->
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h2>Visor de Registros del Sistema</h2>
            <p class="text-muted">Consulta y gestiona los registros de actividad del sistema</p>
        </div>
        <div class="admin-user-info">
            <span><i class="bi bi-person-circle"></i> {{current_user.full_name}}</span>
            <a href="/admin" class="btn btn-sm btn-neutral">
                <i class="bi bi-arrow-left"></i> Admin
            </a>
            <a href="/logout" class="btn btn-sm btn-danger">
                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
            </a>
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card stat-info">
            <div class="stat-icon">
                <i class="bi bi-file-text-fill"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{stats.total}}</div>
                <div class="stat-label">Total de Registros</div>
            </div>
        </div>

        <div class="stat-card stat-danger">
            <div class="stat-icon">
                <i class="bi bi-exclamation-circle-fill"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{stats.error_count}}</div>
                <div class="stat-label">Errores</div>
            </div>
        </div>

        <div class="stat-card stat-warning">
            <div class="stat-icon">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{stats.warning_count}}</div>
                <div class="stat-label">Advertencias</div>
            </div>
        </div>

        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="bi bi-info-circle-fill"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{stats.info_count}}</div>
                <div class="stat-label">Información</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
        <form method="GET" class="filter-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="level">Nivel de Log:</label>
                    <select name="level" id="level" class="form-select">
                        <option value="">-- Todos --</option>
                        {{#log_levels}}
                        <option value="{{.}}"{{#current_filters.level}}{{#match}}selected{{/match}}{{/current_filters.level}}>{{.}}</option>
                        {{/log_levels}}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="date_from">Desde:</label>
                    <input type="date" name="date_from" id="date_from" class="form-control" value="{{current_filters.date_from}}" />
                </div>

                <div class="filter-group">
                    <label for="date_to">Hasta:</label>
                    <input type="date" name="date_to" id="date_to" class="form-control" value="{{current_filters.date_to}}" />
                </div>

                <div class="filter-group">
                    <label for="search">Buscar:</label>
                    <input type="text" name="search" id="search" class="form-control" placeholder="Mensaje o canal..." value="{{current_filters.search}}" />
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Filtrar
                    </button>
                    <a href="/admin/logs" class="btn btn-neutral">
                        <i class="bi bi-arrow-clockwise"></i> Limpiar
                    </a>
                </div>
            </div>
        </form>

        <!-- Action Buttons -->
        <div class="action-buttons" style="margin-top: 15px;">
            <div class="download-group">
                <a href="/admin/logs/download?format=csv{{#current_filters.level}}&level={{current_filters.level}}{{/current_filters.level}}{{#current_filters.date_from}}&date_from={{current_filters.date_from}}{{/current_filters.date_from}}{{#current_filters.date_to}}&date_to={{current_filters.date_to}}{{/current_filters.date_to}}{{#current_filters.search}}&search={{current_filters.search}}{{/current_filters.search}}" class="btn btn-info">
                    <i class="bi bi-download"></i> Descargar CSV
                </a>
                <a href="/admin/logs/download?format=json{{#current_filters.level}}&level={{current_filters.level}}{{/current_filters.level}}{{#current_filters.date_from}}&date_from={{current_filters.date_from}}{{/current_filters.date_from}}{{#current_filters.date_to}}&date_to={{current_filters.date_to}}{{/current_filters.date_to}}{{#current_filters.search}}&search={{current_filters.search}}{{/current_filters.search}}" class="btn btn-info">
                    <i class="bi bi-download"></i> Descargar JSON
                </a>
            </div>
            <form method="POST" action="/admin/logs/clear" style="display: inline; margin-left: 10px;" onsubmit="return confirm('¿Está seguro de que desea limpiar los registros antiguos? Esta acción no se puede deshacer.');">
                <input type="hidden" name="confirm" value="yes" />
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-trash"></i> Limpiar Registros Antiguos
                </button>
            </form>
        </div>
    </div>

    <!-- Success/Error Messages -->
    {{#success}}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i>
        <strong>Éxito!</strong> Registros limpiados exitosamente ({{deleted}} eliminados).
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {{/success}}
    {{#error}}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-circle"></i>
        <strong>Error!</strong> {{error}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {{/error}}

    <!-- Logs Table -->
    <div class="section-container">
        <h3>Registros</h3>
        {{#logs}}
        <div class="table-responsive">
            <table class="data-table logs-table">
                <thead>
                    <tr>
                        <th>Fecha/Hora</th>
                        <th>Nivel</th>
                        <th>Mensaje</th>
                        <th>Canal</th>
                        <th>Usuario</th>
                        <th>IP</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {{#logs}}
                    <tr class="log-row log-{{level}}">
                        <td>
                            <small>{{created_at_formatted}}</small>
                        </td>
                        <td>
                            <span class="badge badge-{{level}}">{{level}}</span>
                        </td>
                        <td>
                            <small>{{message}}</small>
                        </td>
                        <td>
                            <span class="channel-badge">{{channel}}</span>
                        </td>
                        <td>
                            {{#user_full_name}}
                            <small>{{user_full_name}}</small>
                            {{/user_full_name}}
                            {{^user_full_name}}
                            <small class="text-muted">Sistema</small>
                            {{/user_full_name}}
                        </td>
                        <td>
                            <code style="font-size: 0.8em;">{{ip_address}}</code>
                        </td>
                        <td>
                            <a href="/admin/logs/view/{{id}}" class="btn btn-sm btn-info" title="Ver detalles">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {{/logs}}
                </tbody>
            </table>
        </div>
        {{/logs}}
        {{^logs}}
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i>
            No hay registros para los filtros seleccionados.
        </div>
        {{/logs}}
    </div>

    <!-- Pagination -->
    {{#pagination.total_logs}}
    <div class="pagination-section">
        <div class="pagination-info">
            <p>Mostrando registros de la página {{pagination.current_page}} de {{pagination.total_pages}} (Total: {{pagination.total_logs}})</p>
        </div>
        <nav aria-label="Pagination">
            <ul class="pagination">
                {{#pagination.has_prev}}
                <li class="page-item">
                    <a class="page-link" href="/admin/logs?page=1{{#current_filters.level}}&level={{current_filters.level}}{{/current_filters.level}}{{#current_filters.date_from}}&date_from={{current_filters.date_from}}{{/current_filters.date_from}}{{#current_filters.date_to}}&date_to={{current_filters.date_to}}{{/current_filters.date_to}}{{#current_filters.search}}&search={{current_filters.search}}{{/current_filters.search}}">Primera</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="/admin/logs?page={{pagination.prev_page}}{{#current_filters.level}}&level={{current_filters.level}}{{/current_filters.level}}{{#current_filters.date_from}}&date_from={{current_filters.date_from}}{{/current_filters.date_from}}{{#current_filters.date_to}}&date_to={{current_filters.date_to}}{{/current_filters.date_to}}{{#current_filters.search}}&search={{current_filters.search}}{{/current_filters.search}}">Anterior</a>
                </li>
                {{/pagination.has_prev}}

                {{#pagination.has_next}}
                <li class="page-item">
                    <a class="page-link" href="/admin/logs?page={{pagination.next_page}}{{#current_filters.level}}&level={{current_filters.level}}{{/current_filters.level}}{{#current_filters.date_from}}&date_from={{current_filters.date_from}}{{/current_filters.date_from}}{{#current_filters.date_to}}&date_to={{current_filters.date_to}}{{/current_filters.date_to}}{{#current_filters.search}}&search={{current_filters.search}}{{/current_filters.search}}">Siguiente</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="/admin/logs?page={{pagination.total_pages}}{{#current_filters.level}}&level={{current_filters.level}}{{/current_filters.level}}{{#current_filters.date_from}}&date_from={{current_filters.date_from}}{{/current_filters.date_from}}{{#current_filters.date_to}}&date_to={{current_filters.date_to}}{{/current_filters.date_to}}{{#current_filters.search}}&search={{current_filters.search}}{{/current_filters.search}}">Última</a>
                </li>
                {{/pagination.has_next}}
            </ul>
        </nav>
    </div>
    {{/pagination.total_logs}}
</div>

<style>
    .filter-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .filter-actions {
        display: flex;
        gap: 10px;
    }

    .filter-actions button,
    .filter-actions a {
        white-space: nowrap;
    }

    .download-group {
        display: flex;
        gap: 10px;
    }

    .logs-table tbody tr {
        border-left: 4px solid transparent;
    }

    .logs-table tbody tr.log-error {
        border-left-color: #dc3545;
        background-color: rgba(220, 53, 69, 0.05);
    }

    .logs-table tbody tr.log-warning {
        border-left-color: #ffc107;
        background-color: rgba(255, 193, 7, 0.05);
    }

    .logs-table tbody tr.log-info {
        border-left-color: #0dcaf0;
    }

    .logs-table tbody tr.log-debug {
        border-left-color: #6c757d;
        opacity: 0.8;
    }

    .channel-badge {
        display: inline-block;
        padding: 3px 8px;
        background: #e7f3ff;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .badge-error {
        background-color: #dc3545;
        color: white;
    }

    .badge-warning {
        background-color: #ffc107;
        color: #000;
    }

    .badge-info {
        background-color: #0dcaf0;
        color: #000;
    }

    .badge-debug {
        background-color: #6c757d;
        color: white;
    }

    .badge-emergency,
    .badge-alert,
    .badge-critical {
        background-color: #721c24;
        color: white;
    }

    .badge-notice {
        background-color: #004085;
        color: white;
    }

    .section-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .section-container h3 {
        margin-bottom: 15px;
        color: #333;
    }

    .pagination-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .pagination-info p {
        margin: 0;
        font-size: 0.9rem;
    }

    .pagination {
        margin: 0;
    }

    .action-buttons {
        background: white;
        padding: 15px;
        border-radius: 8px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
</style>
