<!-- Gestión de Permisos -->
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h2>Gestión de Permisos</h2>
            <p class="text-muted">Administra permisos del sistema agrupados por módulo</p>
        </div>
        <div class="user-actions">
            <a href="/admin/permissions/create" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle"></i> Nuevo Permiso
            </a>
            <a href="/admin/roles" class="btn btn-sm btn-secondary">
                <i class="bi bi-shield-check"></i> Roles
            </a>
            <a href="/admin" class="btn btn-sm btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-section">
        <div class="stat-card">
            <i class="bi bi-key-fill"></i>
            <div>
                <strong>{{total_permissions}}</strong>
                <span>Permisos Totales</span>
            </div>
        </div>
        <div class="stat-card">
            <i class="bi bi-grid-3x3-gap-fill"></i>
            <div>
                <strong>{{modules.length}}</strong>
                <span>Módulos</span>
            </div>
        </div>
    </div>

    <!-- Permisos por Módulo -->
    <div class="permissions-section">
        {{#permissions_grouped}}
        <div class="module-card">
            <div class="module-header">
                <h3><i class="bi bi-folder-fill"></i> {{@key}}</h3>
                <span class="module-count">{{this.length}} permisos</span>
            </div>
            <div class="permissions-table">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Slug</th>
                            <th>Descripción</th>
                            <th>Roles</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#.}}
                        <tr>
                            <td>
                                <div class="perm-name">
                                    <i class="bi bi-key"></i>
                                    <strong>{{name}}</strong>
                                </div>
                            </td>
                            <td><code>{{slug}}</code></td>
                            <td class="text-secondary">{{description}}</td>
                            <td>
                                <div class="roles-list">
                                    {{#role_names}}
                                    <span class="role-badge">{{.}}</span>
                                    {{/role_names}}
                                    {{^role_names}}
                                    <span class="text-muted">Sin roles</span>
                                    {{/role_names}}
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <form method="POST" action="/admin/permissions/edit" style="display:inline;">
                                        <input type="hidden" name="permission_id" value="{{permission_id}}">
                                        <button type="submit" class="btn-icon" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </form>
                                    <button onclick="deletePermission('{{permission_id}}')" class="btn-icon btn-danger" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{/.}}
                    </tbody>
                </table>
            </div>
        </div>
        {{/permissions_grouped}}
    </div>
</div>

<style>
.admin-container{padding:20px 0;max-width:1400px;margin:0 auto}.admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid var(--border-color)}.admin-header h2{color:var(--text-primary);margin:0 0 5px 0}.text-muted{color:var(--text-secondary);margin:0}.user-actions{display:flex;gap:10px}.btn-sm{padding:8px 16px;font-size:.875rem}.btn-primary{background:var(--iser-red);color:#fff}.btn-primary:hover{background:#c82333}.btn-secondary{background:var(--bg-secondary);color:var(--text-primary)}.btn-secondary:hover{background:var(--border-color)}.stats-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}.stat-card{background:var(--bg-secondary);border-radius:12px;padding:25px;display:flex;gap:20px;align-items:center}.stat-card i{font-size:2.5rem;color:var(--iser-red)}.stat-card strong{display:block;font-size:2rem;color:var(--text-primary)}.stat-card span{color:var(--text-secondary)}.permissions-section{display:flex;flex-direction:column;gap:20px}.module-card{background:var(--bg-secondary);border-radius:12px;overflow:hidden}.module-header{background:var(--bg-primary);padding:20px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--iser-red)}.module-header h3{margin:0;color:var(--text-primary);display:flex;align-items:center;gap:10px;text-transform:capitalize}.module-header i{color:var(--iser-red)}.module-count{background:var(--iser-green);color:#fff;padding:6px 12px;border-radius:20px;font-size:.85rem;font-weight:600}.permissions-table{padding:20px}.data-table{width:100%;border-collapse:collapse}.data-table thead{border-bottom:2px solid var(--border-color)}.data-table th{text-align:left;padding:12px 15px;color:var(--text-primary);font-weight:600;font-size:.9rem}.data-table td{padding:12px 15px;color:var(--text-secondary);border-bottom:1px solid var(--border-color)}.data-table tbody tr:last-child td{border-bottom:none}.data-table tbody tr:hover{background:var(--bg-primary)}.perm-name{display:flex;align-items:center;gap:8px}.perm-name i{color:var(--iser-red)}.text-secondary{color:var(--text-secondary)}code{background:var(--bg-primary);padding:4px 8px;border-radius:4px;font-family:monospace;color:var(--iser-green)}.roles-list{display:flex;gap:5px;flex-wrap:wrap}.role-badge{background:var(--iser-blue);color:#fff;padding:4px 10px;border-radius:4px;font-size:.8rem}.action-buttons{display:flex;gap:8px}.btn-icon{background:none;border:none;cursor:pointer;padding:6px 10px;border-radius:4px;color:var(--text-secondary)}.btn-icon:hover{background:var(--bg-primary);color:var(--iser-red)}.btn-icon.btn-danger:hover{background:#f8d7da;color:#721c24}
</style>

<script>
function deletePermission(permId) {
    if (!confirm('¿Estás seguro de que deseas eliminar este permiso?\n\nNOTA: No se puede eliminar si está asignado a roles.')) {
        return;
    }
    const formData = new FormData();
    formData.append('permission_id', permId);

    fetch('/admin/permissions/delete', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) window.location.reload();
        else alert(data.error || 'Error al eliminar permiso');
    })
    .catch(() => alert('Error al eliminar permiso'));
}
</script>
