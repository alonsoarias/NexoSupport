<!-- Subir Nuevo Plugin -->
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h2>{{#__}}plugins.upload_title{{/__}}</h2>
            <p class="text-muted">{{#__}}plugins.upload_description{{/__}}</p>
        </div>
        <div class="plugin-actions">
            <a href="/admin/plugins" class="btn btn-sm btn-secondary">
                <i class="bi bi-arrow-left"></i> {{#__}}plugins.back_to_plugins{{/__}}
            </a>
        </div>
    </div>

    <!-- Mensajes de éxito/error -->
    {{#success_message}}
    <div class="alert alert-success">
        <i class="bi bi-check-circle"></i>
        {{success_message}}
    </div>
    {{/success_message}}

    {{#error_message}}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i>
        {{error_message}}
    </div>
    {{/error_message}}

    <!-- Upload Form -->
    <div class="upload-container">
        <div class="upload-card">
            <div class="card-header">
                <h3><i class="bi bi-cloud-upload"></i> {{#__}}plugins.upload_form_title{{/__}}</h3>
            </div>

            <div class="card-body">
                <!-- Instrucciones -->
                <div class="upload-instructions">
                    <h4>{{#__}}plugins.instructions_title{{/__}}</h4>
                    <ol>
                        <li>{{#__}}plugins.instruction_1{{/__}}</li>
                        <li>{{#__}}plugins.instruction_2{{/__}}</li>
                        <li>{{#__}}plugins.instruction_3{{/__}}</li>
                        <li>{{#__}}plugins.instruction_4{{/__}}</li>
                    </ol>
                </div>

                <!-- Formulario de Upload -->
                <form id="plugin-upload-form" method="POST" action="/admin/plugins/upload" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{csrf_token}}">

                    <!-- Drag & Drop Area -->
                    <div id="drop-zone" class="drop-zone">
                        <div class="drop-zone-content">
                            <i class="bi bi-cloud-arrow-up drop-zone-icon"></i>
                            <p class="drop-zone-title">{{#__}}plugins.drag_drop_title{{/__}}</p>
                            <p class="drop-zone-subtitle">{{#__}}plugins.or{{/__}}</p>
                            <label for="plugin-file" class="btn btn-primary btn-browse">
                                <i class="bi bi-folder2-open"></i> {{#__}}plugins.browse_button{{/__}}
                            </label>
                            <input type="file"
                                   id="plugin-file"
                                   name="plugin_file"
                                   accept=".zip"
                                   required
                                   style="display: none;">
                        </div>

                        <!-- File Info (hidden by default) -->
                        <div id="file-info" class="file-info" style="display: none;">
                            <div class="file-icon">
                                <i class="bi bi-file-earmark-zip"></i>
                            </div>
                            <div class="file-details">
                                <div class="file-name" id="file-name"></div>
                                <div class="file-size" id="file-size"></div>
                            </div>
                            <button type="button" class="btn-remove" onclick="removeFile()">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Requisitos del Plugin -->
                    <div class="requirements-box">
                        <h5><i class="bi bi-info-circle"></i> {{#__}}plugins.requirements_title{{/__}}</h5>
                        <ul>
                            <li>{{#__}}plugins.requirement_1{{/__}}</li>
                            <li>{{#__}}plugins.requirement_2{{/__}}</li>
                            <li>{{#__}}plugins.requirement_3{{/__}}</li>
                            <li>{{#__}}plugins.requirement_4{{/__}}</li>
                        </ul>
                    </div>

                    <!-- Progress Bar (hidden by default) -->
                    <div id="upload-progress" class="upload-progress" style="display: none;">
                        <div class="progress-label">
                            <span id="progress-text">{{#__}}plugins.uploading{{/__}}...</span>
                            <span id="progress-percent">0%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="progress-bar" class="progress-bar"></div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                            <i class="bi bi-upload"></i> {{#__}}plugins.install_button{{/__}}
                        </button>
                        <a href="/admin/plugins" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> {{#__}}common.cancel{{/__}}
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Información Adicional -->
        <div class="info-sidebar">
            <!-- Plugin Manifest Structure -->
            <div class="info-card">
                <div class="card-header">
                    <h4><i class="bi bi-file-earmark-code"></i> {{#__}}plugins.manifest_title{{/__}}</h4>
                </div>
                <div class="card-body">
                    <p class="small text-muted">{{#__}}plugins.manifest_description{{/__}}</p>
                    <pre class="code-block"><code>{
  "slug": "mi-plugin",
  "name": "Mi Plugin",
  "type": "tool",
  "version": "1.0.0",
  "author": "Autor",
  "description": "Descripción",
  "requires": "1.0.0"
}</code></pre>
                </div>
            </div>

            <!-- Tipos de Plugin -->
            <div class="info-card">
                <div class="card-header">
                    <h4><i class="bi bi-puzzle"></i> {{#__}}plugins.types_title{{/__}}</h4>
                </div>
                <div class="card-body">
                    <ul class="plugin-types-list">
                        <li><strong>tool</strong> - {{#__}}plugins.type_tool{{/__}}</li>
                        <li><strong>auth</strong> - {{#__}}plugins.type_auth{{/__}}</li>
                        <li><strong>theme</strong> - {{#__}}plugins.type_theme{{/__}}</li>
                        <li><strong>report</strong> - {{#__}}plugins.type_report{{/__}}</li>
                        <li><strong>module</strong> - {{#__}}plugins.type_module{{/__}}</li>
                        <li><strong>integration</strong> - {{#__}}plugins.type_integration{{/__}}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-container {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 2rem;
    margin-top: 2rem;
}

.upload-card, .info-card {
    background: var(--card-bg, #fff);
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color, #e0e0e0);
}

.card-header h3, .card-header h4 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary, #333);
}

.card-body {
    padding: 2rem;
}

.upload-instructions {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 6px;
    margin-bottom: 2rem;
}

.upload-instructions h4 {
    margin-top: 0;
    color: var(--iser-blue, #0066cc);
}

.upload-instructions ol {
    margin: 0;
    padding-left: 1.5rem;
}

.upload-instructions li {
    margin-bottom: 0.5rem;
}

.drop-zone {
    border: 2px dashed var(--border-color, #ccc);
    border-radius: 8px;
    padding: 3rem 2rem;
    text-align: center;
    transition: all 0.3s ease;
    background: #fafafa;
    cursor: pointer;
}

.drop-zone.dragover {
    border-color: var(--iser-blue, #0066cc);
    background: #e3f2fd;
}

.drop-zone-content i.drop-zone-icon {
    font-size: 4rem;
    color: var(--iser-blue, #0066cc);
    margin-bottom: 1rem;
}

.drop-zone-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary, #333);
    margin-bottom: 0.5rem;
}

.drop-zone-subtitle {
    color: var(--text-muted, #666);
    margin-bottom: 1.5rem;
}

.btn-browse {
    cursor: pointer;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: #fff;
    border-radius: 6px;
}

.file-icon i {
    font-size: 3rem;
    color: var(--iser-blue, #0066cc);
}

.file-details {
    flex: 1;
}

.file-name {
    font-weight: 600;
    color: var(--text-primary, #333);
    margin-bottom: 0.25rem;
}

.file-size {
    font-size: 0.875rem;
    color: var(--text-muted, #666);
}

.btn-remove {
    background: none;
    border: none;
    color: var(--iser-red, #dc3545);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
}

.btn-remove:hover {
    color: #c82333;
}

.requirements-box {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 6px;
    padding: 1.5rem;
    margin-top: 2rem;
}

.requirements-box h5 {
    margin-top: 0;
    color: #856404;
}

.requirements-box ul {
    margin-bottom: 0;
}

.upload-progress {
    margin-top: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 6px;
}

.progress-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.progress-bar-container {
    height: 24px;
    background: #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--iser-blue, #0066cc), var(--iser-green, #28a745));
    transition: width 0.3s ease;
    width: 0%;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.info-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.code-block {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    font-size: 0.875rem;
}

.plugin-types-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.plugin-types-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color, #e0e0e0);
}

.plugin-types-list li:last-child {
    border-bottom: none;
}

@media (max-width: 1024px) {
    .upload-container {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Drag & Drop functionality
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('plugin-file');
const fileInfo = document.getElementById('file-info');
const dropZoneContent = document.querySelector('.drop-zone-content');
const submitBtn = document.getElementById('submit-btn');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    dropZone.classList.add('dragover');
}

function unhighlight(e) {
    dropZone.classList.remove('dragover');
}

// Handle dropped files
dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;

    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect();
    }
}

// Handle file selection via input
fileInput.addEventListener('change', handleFileSelect);

function handleFileSelect() {
    const file = fileInput.files[0];

    if (file) {
        // Validate file type
        if (!file.name.endsWith('.zip')) {
            alert('{{#__}}plugins.error_invalid_file{{/__}}');
            return;
        }

        // Validate file size (100MB max)
        const maxSize = 100 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('{{#__}}plugins.error_file_too_large{{/__}}');
            return;
        }

        // Display file info
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = formatFileSize(file.size);

        dropZoneContent.style.display = 'none';
        fileInfo.style.display = 'flex';
        submitBtn.disabled = false;
    }
}

function removeFile() {
    fileInput.value = '';
    dropZoneContent.style.display = 'block';
    fileInfo.style.display = 'none';
    submitBtn.disabled = true;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Handle form submission with progress
document.getElementById('plugin-upload-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressPercent = document.getElementById('progress-percent');

    progressDiv.style.display = 'block';
    submitBtn.disabled = true;

    const xhr = new XMLHttpRequest();

    // Track upload progress
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressBar.style.width = percentComplete + '%';
            progressPercent.textContent = Math.round(percentComplete) + '%';
        }
    });

    xhr.addEventListener('load', function() {
        if (xhr.status === 200 || xhr.status === 201) {
            progressText.textContent = '{{#__}}plugins.installation_complete{{/__}}';
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';

            try {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    setTimeout(() => {
                        window.location.href = '/admin/plugins?success=' + encodeURIComponent('{{#__}}plugins.installed_message{{/__}}');
                    }, 1000);
                } else {
                    alert('{{#__}}plugins.error_installation{{/__}}: ' + (response.message || 'Unknown error'));
                    progressDiv.style.display = 'none';
                    submitBtn.disabled = false;
                }
            } catch (e) {
                window.location.href = '/admin/plugins';
            }
        } else {
            alert('{{#__}}plugins.error_upload{{/__}}');
            progressDiv.style.display = 'none';
            submitBtn.disabled = false;
        }
    });

    xhr.addEventListener('error', function() {
        alert('{{#__}}plugins.error_network{{/__}}');
        progressDiv.style.display = 'none';
        submitBtn.disabled = false;
    });

    xhr.open('POST', '/admin/plugins/upload');
    xhr.send(formData);
});
</script>
