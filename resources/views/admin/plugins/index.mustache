<!-- Gestión de Plugins -->
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h2>Gestión de Plugins</h2>
            <p class="text-muted">Administra y controla los plugins del sistema</p>
        </div>
        <div class="plugin-actions">
            <a href="/admin/plugins/upload" class="btn btn-sm btn-primary">
                <i class="bi bi-cloud-upload"></i> Subir Nuevo Plugin
            </a>
            <button onclick="discoverPlugins()" class="btn btn-sm btn-secondary">
                <i class="bi bi-search"></i> Descubrir Plugins
            </button>
            <a href="/admin" class="btn btn-sm btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <!-- Mensajes de éxito/error -->
    {{#success_message}}
    <div class="alert alert-success">
        <i class="bi bi-check-circle"></i>
        {{success_message}}
    </div>
    {{/success_message}}

    {{#error_message}}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i>
        {{error_message}}
    </div>
    {{/error_message}}

    <!-- Estadísticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: var(--iser-blue);">
                <i class="bi bi-puzzle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{stats.total}}</div>
                <div class="stat-label">Plugins Totales</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: var(--iser-green);">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{stats.enabled}}</div>
                <div class="stat-label">Habilitados</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: var(--iser-red);">
                <i class="bi bi-dash-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{stats.disabled}}</div>
                <div class="stat-label">Deshabilitados</div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
        <form method="GET" action="/admin/plugins" class="filters-form">
            <div class="filter-group">
                <input type="text" name="search" placeholder="Buscar por nombre o descripción..."
                       value="{{filters.search}}" class="form-input">
            </div>
            <div class="filter-group">
                <select name="status" class="form-select">
                    <option value="">Todos los Estados</option>
                    <option value="1">Habilitados</option>
                    <option value="0">Deshabilitados</option>
                </select>
            </div>
            <div class="filter-group">
                <select name="type" class="form-select">
                    <option value="">Todos los Tipos</option>
                    <option value="auth">Autenticación</option>
                    <option value="theme">Tema</option>
                    <option value="tool">Herramienta</option>
                    <option value="module">Módulo</option>
                    <option value="integration">Integración</option>
                    <option value="report">Reporte</option>
                </select>
            </div>
            <button type="submit" class="btn btn-sm btn-primary">
                <i class="bi bi-search"></i> Filtrar
            </button>
            <a href="/admin/plugins" class="btn btn-sm btn-secondary">
                <i class="bi bi-x-circle"></i> Limpiar
            </a>
        </form>
    </div>

    <!-- Tabla de plugins -->
    <div class="table-section">
        <div class="table-header">
            <h3>
                <i class="bi bi-puzzle-fill"></i> Plugins Instalados
                <span class="count-badge">{{plugins_count}} total</span>
            </h3>
        </div>

        {{#plugins}}
        <div class="plugins-grid">
            {{#plugins}}
            <div class="plugin-card">
                <div class="plugin-header">
                    <div class="plugin-icon">
                        <i class="bi {{#type_icon}}{{type_icon}}{{/type_icon}}{{^type_icon}}bi-puzzle{{/type_icon}}"></i>
                    </div>
                    <div class="plugin-info">
                        <h4>{{name}}</h4>
                        <p class="plugin-author">por {{author}}</p>
                    </div>
                    {{#is_core}}
                    <span class="badge badge-info">Sistema</span>
                    {{/is_core}}
                </div>

                <div class="plugin-meta">
                    <div class="meta-item">
                        <span class="meta-label">Versión:</span>
                        <span class="meta-value">{{version}}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Tipo:</span>
                        <span class="meta-value">
                            {{#type}}
                                {{#type_auth}}Autenticación{{/type_auth}}
                                {{#type_theme}}Tema{{/type_theme}}
                                {{#type_tool}}Herramienta{{/type_tool}}
                                {{#type_module}}Módulo{{/type_module}}
                                {{#type_integration}}Integración{{/type_integration}}
                                {{#type_report}}Reporte{{/type_report}}
                            {{/type}}
                        </span>
                    </div>
                </div>

                {{#description}}
                <div class="plugin-description">
                    {{description}}
                </div>
                {{/description}}

                <div class="plugin-status">
                    {{#enabled}}
                    <span class="badge badge-success">Habilitado</span>
                    {{/enabled}}
                    {{^enabled}}
                    <span class="badge badge-warning">Deshabilitado</span>
                    {{/enabled}}
                </div>

                <div class="plugin-actions">
                    {{#enabled}}
                    <button onclick="disablePlugin('{{slug}}')" class="btn-action btn-warning" title="Deshabilitar">
                        <i class="bi bi-pause"></i> Deshabilitar
                    </button>
                    {{/enabled}}
                    {{^enabled}}
                    <button onclick="enablePlugin('{{slug}}')" class="btn-action btn-success" title="Habilitar">
                        <i class="bi bi-play"></i> Habilitar
                    </button>
                    {{/enabled}}

                    <a href="/admin/plugins/{{slug}}" class="btn-action btn-info" title="Ver Detalles">
                        <i class="bi bi-eye"></i> Detalles
                    </a>

                    {{^is_core}}
                    <button onclick="uninstallPlugin('{{slug}}')" class="btn-action btn-danger" title="Desinstalar">
                        <i class="bi bi-trash"></i> Desinstalar
                    </button>
                    {{/is_core}}
                </div>
            </div>
            {{/plugins}}
        </div>
        {{/plugins}}

        {{^plugins}}
        <div class="no-data">
            <i class="bi bi-inbox"></i>
            <p>No se encontraron plugins</p>
            <a href="/admin/plugins/upload" class="btn btn-primary">
                <i class="bi bi-cloud-upload"></i> Subir primer plugin
            </a>
        </div>
        {{/plugins}}
    </div>

    <!-- Quick Links -->
    <div class="quick-links">
        <h3><i class="bi bi-info-circle"></i> Información</h3>
        <div class="quick-links-grid">
            <a href="/admin" class="quick-link-card">
                <i class="bi bi-speedometer2"></i>
                <div>
                    <strong>Panel de Control</strong>
                    <p>Volver al panel principal</p>
                </div>
            </a>
            <a href="/admin/users" class="quick-link-card">
                <i class="bi bi-people"></i>
                <div>
                    <strong>Gestión de Usuarios</strong>
                    <p>Administrar usuarios del sistema</p>
                </div>
            </a>
        </div>
    </div>
</div>

<style>
.admin-container {
    padding: 20px 0;
    max-width: 1400px;
    margin: 0 auto;
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
}

.admin-header h2 {
    color: var(--text-primary);
    margin: 0 0 5px 0;
}

.text-muted {
    color: var(--text-secondary);
    margin: 0;
}

.plugin-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 0.875rem;
}

.btn-primary {
    background: var(--iser-red);
    color: white;
}

.btn-primary:hover {
    background: #c82333;
}

.btn-secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--border-color);
}

/* Alerts */
.alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border-left: 4px solid #28a745;
}

.alert-danger {
    background: #f8d7da;
    color: #721c24;
    border-left: 4px solid #dc3545;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    gap: 15px;
    align-items: center;
    border-left: 4px solid transparent;
    transition: all 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-top: 5px;
}

/* Filters */
.filters-section {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.filters-form {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.form-input, .form-select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-primary);
    color: var(--text-primary);
}

/* Table Section */
.table-section {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
}

.table-header {
    margin-bottom: 25px;
}

.table-header h3 {
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.3rem;
}

.count-badge {
    background: var(--iser-green);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

/* Plugins Grid */
.plugins-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.plugin-card {
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 20px;
    border: 2px solid var(--border-color);
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
}

.plugin-card:hover {
    border-color: var(--iser-red);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.15);
    transform: translateY(-2px);
}

.plugin-header {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
    align-items: flex-start;
}

.plugin-icon {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    background: var(--iser-red);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.plugin-header h4 {
    color: var(--text-primary);
    margin: 0 0 5px 0;
    font-size: 1.1rem;
}

.plugin-info {
    flex: 1;
    min-width: 0;
}

.plugin-author {
    color: var(--text-secondary);
    font-size: 0.85rem;
    margin: 0;
}

.plugin-meta {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.9rem;
}

.meta-item {
    display: flex;
    gap: 5px;
}

.meta-label {
    color: var(--text-secondary);
    font-weight: 600;
}

.meta-value {
    color: var(--text-primary);
}

.plugin-description {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 15px;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.plugin-status {
    margin-bottom: 15px;
}

.badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
}

.badge-success {
    background: #28a745;
}

.badge-warning {
    background: #ffc107;
    color: #333;
}

.badge-danger {
    background: #dc3545;
}

.badge-info {
    background: var(--iser-blue);
}

.plugin-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: auto;
}

.btn-action {
    flex: 1;
    min-width: 90px;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s;
    font-weight: 500;
}

.btn-success {
    background: #d4edda;
    color: #155724;
}

.btn-success:hover {
    background: #c3e6cb;
}

.btn-warning {
    background: #fff3cd;
    color: #856404;
}

.btn-warning:hover {
    background: #ffeaa7;
}

.btn-danger {
    background: #f8d7da;
    color: #721c24;
}

.btn-danger:hover {
    background: #f5c6cb;
}

.btn-info {
    background: #d1ecf1;
    color: #0c5460;
}

.btn-info:hover {
    background: #bee5eb;
}

/* No Data */
.no-data {
    padding: 60px 20px;
    text-align: center;
}

.no-data i {
    font-size: 4rem;
    color: var(--text-secondary);
    opacity: 0.5;
    margin-bottom: 20px;
}

.no-data p {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin: 0 0 20px 0;
}

/* Quick Links */
.quick-links {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 30px;
}

.quick-links h3 {
    color: var(--text-primary);
    margin: 0 0 20px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2rem;
}

.quick-links-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.quick-link-card {
    background: var(--bg-primary);
    border-radius: 8px;
    padding: 20px;
    display: flex;
    gap: 15px;
    align-items: center;
    text-decoration: none;
    border: 2px solid var(--border-color);
    transition: all 0.2s;
}

.quick-link-card:hover {
    border-color: var(--iser-red);
    transform: translateY(-2px);
}

.quick-link-card i {
    font-size: 2.5rem;
    color: var(--iser-red);
}

.quick-link-card strong {
    display: block;
    color: var(--text-primary);
    margin-bottom: 5px;
    font-size: 1rem;
}

.quick-link-card p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 768px) {
    .admin-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }

    .plugin-actions {
        flex-direction: column;
        width: 100%;
    }

    .filters-form {
        flex-direction: column;
    }

    .filter-group {
        width: 100%;
    }

    .plugins-grid {
        grid-template-columns: 1fr;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .quick-links-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function enablePlugin(slug) {
    if (!confirm('¿Habilitar este plugin?')) {
        return;
    }

    fetch('/admin/plugins/' + slug + '/enable', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Error al habilitar plugin');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al habilitar plugin');
    });
}

function disablePlugin(slug) {
    if (!confirm('¿Estás seguro de que deseas deshabilitar este plugin?')) {
        return;
    }

    fetch('/admin/plugins/' + slug + '/disable', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Error al deshabilitar plugin');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al deshabilitar plugin');
    });
}

function uninstallPlugin(slug) {
    if (!confirm('¿Estás seguro de que deseas desinstalar este plugin? Esta acción no se puede deshacer.')) {
        return;
    }

    fetch('/admin/plugins/' + slug, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Error al desinstalar plugin');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al desinstalar plugin');
    });
}

function discoverPlugins() {
    const button = event.target.closest('button');
    const originalText = button.textContent;
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Buscando...';

    fetch('/admin/plugins/discover', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.data.new.length > 0) {
                alert('Se encontraron ' + data.data.new.length + ' nuevos plugins disponibles');
            } else {
                alert('No se encontraron plugins nuevos');
            }
        } else {
            alert(data.message || 'Error al descubrir plugins');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al descubrir plugins');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}
</script>
