<?xml version="1.0" encoding="UTF-8"?>
<database>
    <metadata>
        <name>NexoSupport Sistema de Soporte - Base de Datos Normalizada</name>
        <version>2.0.0</version>
        <charset>utf8mb4</charset>
        <collation>utf8mb4_unicode_ci</collation>
        <engine>InnoDB</engine>
    </metadata>

    <!-- Core Configuration Table (NORMALIZADA - Consolidada con report_config) -->
    <table name="config">
        <description>System configuration - Unified configuration table</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="config_key" type="VARCHAR(100)" null="false" unique="true"/>
            <column name="config_value" type="TEXT"/>
            <column name="config_type" type="ENUM('string','int','bool','json')" default="string"/>
            <column name="category" type="VARCHAR(50)" default="general"/>
            <column name="description" type="VARCHAR(255)"/>
            <column name="is_public" type="BOOLEAN" default="false"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_config_key" columns="config_key"/>
            <index name="idx_category" columns="category"/>
        </indexes>
        <data>
            <!-- App Configuration -->
            <row>
                <config_key>app.name</config_key>
                <config_value>NexoSupport Sistema de Soporte</config_value>
                <config_type>string</config_type>
                <category>app</category>
                <description>Application name</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>app.version</config_key>
                <config_value>2.0.0</config_value>
                <config_type>string</config_type>
                <category>app</category>
                <description>Application version</description>
                <is_public>1</is_public>
            </row>

            <!-- Security Configuration -->
            <row>
                <config_key>security.password_min_length</config_key>
                <config_value>8</config_value>
                <config_type>int</config_type>
                <category>security</category>
                <description>Minimum password length</description>
                <is_public>0</is_public>
            </row>
            <row>
                <config_key>security.max_login_attempts</config_key>
                <config_value>5</config_value>
                <config_type>int</config_type>
                <category>security</category>
                <description>Maximum login attempts before lockout</description>
                <is_public>0</is_public>
            </row>
            <row>
                <config_key>security.lockout_duration</config_key>
                <config_value>900</config_value>
                <config_type>int</config_type>
                <category>security</category>
                <description>Account lockout duration in seconds</description>
                <is_public>0</is_public>
            </row>

            <!-- Report Configuration (CONSOLIDADAS de report_config) -->
            <row>
                <config_key>report.retention_days</config_key>
                <config_value>90</config_value>
                <config_type>int</config_type>
                <category>reports</category>
                <description>Log retention period in days</description>
                <is_public>0</is_public>
            </row>
            <row>
                <config_key>report.max_export_rows</config_key>
                <config_value>10000</config_value>
                <config_type>int</config_type>
                <category>reports</category>
                <description>Maximum rows in report exports</description>
                <is_public>0</is_public>
            </row>
            <row>
                <config_key>report.default_format</config_key>
                <config_value>pdf</config_value>
                <config_type>string</config_type>
                <category>reports</category>
                <description>Default report export format</description>
                <is_public>0</is_public>
            </row>
        </data>
    </table>

    <!-- Users Table (NORMALIZADA - Separación de datos de autenticación y perfil) -->
    <table name="users">
        <description>System users - Authentication data only</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="username" type="VARCHAR(50)" null="false" unique="true"/>
            <column name="email" type="VARCHAR(255)" null="false" unique="true"/>
            <column name="password" type="VARCHAR(255)" null="false"/>
            <column name="first_name" type="VARCHAR(100)"/>
            <column name="last_name" type="VARCHAR(100)"/>
            <column name="status" type="ENUM('active','inactive','suspended','pending')" default="active"/>
            <column name="email_verified" type="BOOLEAN" default="false"/>
            <column name="email_verification_token" type="VARCHAR(64)"/>
            <column name="email_verification_expires" type="INT UNSIGNED"/>
            <column name="last_login_at" type="INT UNSIGNED"/>
            <column name="last_login_ip" type="VARCHAR(45)"/>
            <column name="failed_login_attempts" type="INT UNSIGNED" default="0"/>
            <column name="locked_until" type="INT UNSIGNED"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
            <column name="deleted_at" type="INT UNSIGNED"/>
        </columns>
        <indexes>
            <index name="idx_username" columns="username"/>
            <index name="idx_email" columns="email"/>
            <index name="idx_status" columns="status"/>
            <index name="idx_email_verification_token" columns="email_verification_token"/>
            <index name="idx_deleted_at" columns="deleted_at"/>
        </indexes>
    </table>

    <!-- Password Reset Tokens Table (NORMALIZADA - Separada de users) -->
    <table name="password_reset_tokens">
        <description>Password reset tokens - Separated for better normalization</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false"/>
            <column name="token" type="VARCHAR(64)" null="false" unique="true"/>
            <column name="expires_at" type="INT UNSIGNED" null="false"/>
            <column name="used_at" type="INT UNSIGNED"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_token" columns="token"/>
            <index name="idx_expires_at" columns="expires_at"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Login Attempts Table (NORMALIZADA - Agregada FK opcional a users) -->
    <table name="login_attempts">
        <description>Login attempt tracking with optional user reference</description>
        <columns>
            <column name="id" type="BIGINT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED"/>
            <column name="username" type="VARCHAR(255)" null="false"/>
            <column name="ip_address" type="VARCHAR(45)" null="false"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="success" type="BOOLEAN" default="false" null="false"/>
            <column name="attempted_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_username" columns="username"/>
            <index name="idx_ip_address" columns="ip_address"/>
            <index name="idx_attempted_at" columns="attempted_at"/>
            <index name="idx_success" columns="success"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="SET NULL"/>
        </foreignKeys>
    </table>

    <!-- User Profiles Table (NORMALIZADA - 1:1 con users) -->
    <table name="user_profiles">
        <description>User profile information - 1:1 relationship with users</description>
        <columns>
            <column name="user_id" type="INT UNSIGNED" primary="true"/>
            <column name="phone" type="VARCHAR(20)"/>
            <column name="mobile" type="VARCHAR(20)"/>
            <column name="address" type="TEXT"/>
            <column name="city" type="VARCHAR(100)"/>
            <column name="state" type="VARCHAR(100)"/>
            <column name="country" type="VARCHAR(100)"/>
            <column name="postal_code" type="VARCHAR(20)"/>
            <column name="timezone" type="VARCHAR(50)" default="America/Bogota"/>
            <column name="locale" type="VARCHAR(10)" default="es"/>
            <column name="avatar_url" type="VARCHAR(255)"/>
            <column name="bio" type="TEXT"/>
            <column name="metadata" type="JSON"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Roles Table -->
    <table name="roles">
        <description>User roles for RBAC</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="name" type="VARCHAR(50)" null="false" unique="true"/>
            <column name="slug" type="VARCHAR(50)" null="false" unique="true"/>
            <column name="description" type="TEXT"/>
            <column name="level" type="INT UNSIGNED" default="0"/>
            <column name="is_system" type="BOOLEAN" default="false"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_slug" columns="slug"/>
            <index name="idx_level" columns="level"/>
            <index name="idx_is_system" columns="is_system"/>
        </indexes>
        <data>
            <row>
                <name>Administrador</name>
                <slug>admin</slug>
                <description>Administrador del sistema con acceso completo</description>
                <level>100</level>
                <is_system>1</is_system>
            </row>
            <row>
                <name>Moderador</name>
                <slug>moderator</slug>
                <description>Moderador con permisos limitados</description>
                <level>50</level>
                <is_system>1</is_system>
            </row>
            <row>
                <name>Usuario</name>
                <slug>user</slug>
                <description>Usuario estándar del sistema</description>
                <level>10</level>
                <is_system>1</is_system>
            </row>
            <row>
                <name>Invitado</name>
                <slug>guest</slug>
                <description>Usuario invitado con acceso limitado</description>
                <level>1</level>
                <is_system>1</is_system>
            </row>
        </data>
    </table>

    <!-- Permissions Table -->
    <table name="permissions">
        <description>System permissions for granular access control</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="name" type="VARCHAR(100)" null="false" unique="true"/>
            <column name="slug" type="VARCHAR(100)" null="false" unique="true"/>
            <column name="description" type="TEXT"/>
            <column name="module" type="VARCHAR(50)"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_slug" columns="slug"/>
            <index name="idx_module" columns="module"/>
        </indexes>
        <data>
            <!-- Permisos granulares: Usuarios (7 permisos) -->
            <row>
                <name>Ver Usuarios</name>
                <slug>users.view</slug>
                <description>Permite ver la lista de usuarios del sistema</description>
                <module>users</module>
            </row>
            <row>
                <name>Crear Usuarios</name>
                <slug>users.create</slug>
                <description>Permite crear nuevos usuarios en el sistema</description>
                <module>users</module>
            </row>
            <row>
                <name>Editar Usuarios</name>
                <slug>users.update</slug>
                <description>Permite editar información de usuarios existentes</description>
                <module>users</module>
            </row>
            <row>
                <name>Eliminar Usuarios</name>
                <slug>users.delete</slug>
                <description>Permite eliminar usuarios del sistema (soft delete)</description>
                <module>users</module>
            </row>
            <row>
                <name>Restaurar Usuarios</name>
                <slug>users.restore</slug>
                <description>Permite restaurar usuarios eliminados</description>
                <module>users</module>
            </row>
            <row>
                <name>Asignar Roles a Usuarios</name>
                <slug>users.assign_roles</slug>
                <description>Permite asignar o quitar roles de los usuarios</description>
                <module>users</module>
            </row>
            <row>
                <name>Ver Perfil de Usuario</name>
                <slug>users.view_profile</slug>
                <description>Permite ver el perfil detallado de usuarios</description>
                <module>users</module>
            </row>

            <!-- Permisos granulares: Roles (5 permisos) -->
            <row>
                <name>Ver Roles</name>
                <slug>roles.view</slug>
                <description>Permite ver la lista de roles del sistema</description>
                <module>roles</module>
            </row>
            <row>
                <name>Crear Roles</name>
                <slug>roles.create</slug>
                <description>Permite crear nuevos roles en el sistema</description>
                <module>roles</module>
            </row>
            <row>
                <name>Editar Roles</name>
                <slug>roles.update</slug>
                <description>Permite editar roles existentes</description>
                <module>roles</module>
            </row>
            <row>
                <name>Eliminar Roles</name>
                <slug>roles.delete</slug>
                <description>Permite eliminar roles del sistema</description>
                <module>roles</module>
            </row>
            <row>
                <name>Asignar Permisos a Roles</name>
                <slug>roles.assign_permissions</slug>
                <description>Permite asignar o quitar permisos de los roles</description>
                <module>roles</module>
            </row>

            <!-- Permisos granulares: Permisos (4 permisos) -->
            <row>
                <name>Ver Permisos</name>
                <slug>permissions.view</slug>
                <description>Permite ver la lista de permisos del sistema</description>
                <module>permissions</module>
            </row>
            <row>
                <name>Crear Permisos</name>
                <slug>permissions.create</slug>
                <description>Permite crear nuevos permisos en el sistema</description>
                <module>permissions</module>
            </row>
            <row>
                <name>Editar Permisos</name>
                <slug>permissions.update</slug>
                <description>Permite editar permisos existentes</description>
                <module>permissions</module>
            </row>
            <row>
                <name>Eliminar Permisos</name>
                <slug>permissions.delete</slug>
                <description>Permite eliminar permisos del sistema</description>
                <module>permissions</module>
            </row>

            <!-- Permisos granulares: Dashboard (3 permisos) -->
            <row>
                <name>Ver Dashboard</name>
                <slug>dashboard.view</slug>
                <description>Permite acceder al panel de administración</description>
                <module>dashboard</module>
            </row>
            <row>
                <name>Ver Estadísticas</name>
                <slug>dashboard.stats</slug>
                <description>Permite ver estadísticas del sistema</description>
                <module>dashboard</module>
            </row>
            <row>
                <name>Ver Gráficas</name>
                <slug>dashboard.charts</slug>
                <description>Permite ver gráficas y reportes visuales</description>
                <module>dashboard</module>
            </row>

            <!-- Permisos granulares: Configuración (3 permisos) -->
            <row>
                <name>Ver Configuración</name>
                <slug>settings.view</slug>
                <description>Permite ver la configuración del sistema</description>
                <module>settings</module>
            </row>
            <row>
                <name>Editar Configuración</name>
                <slug>settings.update</slug>
                <description>Permite modificar la configuración del sistema</description>
                <module>settings</module>
            </row>
            <row>
                <name>Gestionar Configuración Crítica</name>
                <slug>settings.critical</slug>
                <description>Permite modificar configuraciones críticas del sistema</description>
                <module>settings</module>
            </row>

            <!-- Permisos granulares: Logs (3 permisos) -->
            <row>
                <name>Ver Logs</name>
                <slug>logs.view</slug>
                <description>Permite ver los registros de actividad del sistema</description>
                <module>logs</module>
            </row>
            <row>
                <name>Eliminar Logs</name>
                <slug>logs.delete</slug>
                <description>Permite eliminar registros de actividad</description>
                <module>logs</module>
            </row>
            <row>
                <name>Exportar Logs</name>
                <slug>logs.export</slug>
                <description>Permite exportar registros de actividad</description>
                <module>logs</module>
            </row>

            <!-- Permisos granulares: Auditoría (2 permisos) -->
            <row>
                <name>Ver Auditoría</name>
                <slug>audit.view</slug>
                <description>Permite ver la pista de auditoría del sistema</description>
                <module>audit</module>
            </row>
            <row>
                <name>Exportar Auditoría</name>
                <slug>audit.export</slug>
                <description>Permite exportar registros de auditoría</description>
                <module>audit</module>
            </row>

            <!-- Permisos granulares: Reportes (3 permisos) -->
            <row>
                <name>Ver Reportes</name>
                <slug>reports.view</slug>
                <description>Permite ver reportes del sistema</description>
                <module>reports</module>
            </row>
            <row>
                <name>Generar Reportes</name>
                <slug>reports.generate</slug>
                <description>Permite generar nuevos reportes</description>
                <module>reports</module>
            </row>
            <row>
                <name>Exportar Reportes</name>
                <slug>reports.export</slug>
                <description>Permite exportar reportes en diferentes formatos</description>
                <module>reports</module>
            </row>

            <!-- Permisos granulares: Sesiones (2 permisos) -->
            <row>
                <name>Ver Sesiones</name>
                <slug>sessions.view</slug>
                <description>Permite ver sesiones activas del sistema</description>
                <module>sessions</module>
            </row>
            <row>
                <name>Cerrar Sesiones</name>
                <slug>sessions.terminate</slug>
                <description>Permite cerrar sesiones de otros usuarios</description>
                <module>sessions</module>
            </row>
        </data>
    </table>

    <!-- User Roles Table (Tabla de unión M:N) -->
    <table name="user_roles">
        <description>User to roles relationship - Many-to-Many</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false"/>
            <column name="role_id" type="INT UNSIGNED" null="false"/>
            <column name="assigned_at" type="INT UNSIGNED" null="false"/>
            <column name="assigned_by" type="INT UNSIGNED"/>
            <column name="expires_at" type="INT UNSIGNED"/>
        </columns>
        <indexes>
            <index name="unique_user_role" columns="user_id,role_id" unique="true"/>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_role_id" columns="role_id"/>
            <index name="idx_assigned_by" columns="assigned_by"/>
            <index name="idx_expires_at" columns="expires_at"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
            <foreignKey column="role_id" references="roles(id)" onDelete="CASCADE"/>
            <foreignKey column="assigned_by" references="users(id)" onDelete="SET NULL"/>
        </foreignKeys>
    </table>

    <!-- Role Permissions Table (Tabla de unión M:N) -->
    <table name="role_permissions">
        <description>Role to permissions relationship - Many-to-Many</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="role_id" type="INT UNSIGNED" null="false"/>
            <column name="permission_id" type="INT UNSIGNED" null="false"/>
            <column name="granted_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="unique_role_permission" columns="role_id,permission_id" unique="true"/>
            <index name="idx_role_id" columns="role_id"/>
            <index name="idx_permission_id" columns="permission_id"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="role_id" references="roles(id)" onDelete="CASCADE"/>
            <foreignKey column="permission_id" references="permissions(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Sessions Table -->
    <table name="sessions">
        <description>User sessions</description>
        <columns>
            <column name="id" type="VARCHAR(128)" primary="true"/>
            <column name="user_id" type="INT UNSIGNED"/>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="payload" type="TEXT"/>
            <column name="last_activity" type="INT UNSIGNED" null="false"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_last_activity" columns="last_activity"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- JWT Tokens Table -->
    <table name="jwt_tokens">
        <description>JWT tokens for API authentication</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false"/>
            <column name="token_id" type="VARCHAR(64)" null="false" unique="true"/>
            <column name="token_hash" type="VARCHAR(64)" null="false"/>
            <column name="type" type="ENUM('access','refresh')" default="access"/>
            <column name="expires_at" type="INT UNSIGNED" null="false"/>
            <column name="revoked" type="BOOLEAN" default="false"/>
            <column name="revoked_at" type="INT UNSIGNED"/>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_token_id" columns="token_id"/>
            <index name="idx_expires_at" columns="expires_at"/>
            <index name="idx_revoked" columns="revoked"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- MFA Table -->
    <table name="user_mfa">
        <description>Multi-factor authentication methods</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false"/>
            <column name="method" type="ENUM('totp','sms','email','backup_codes')" null="false"/>
            <column name="secret" type="VARCHAR(255)"/>
            <column name="enabled" type="BOOLEAN" default="false"/>
            <column name="verified" type="BOOLEAN" default="false"/>
            <column name="backup_codes" type="JSON"/>
            <column name="phone" type="VARCHAR(20)"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="unique_user_method" columns="user_id,method" unique="true"/>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_enabled" columns="enabled"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Logs Table -->
    <table name="logs">
        <description>System logs</description>
        <columns>
            <column name="id" type="BIGINT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="level" type="VARCHAR(20)" null="false"/>
            <column name="channel" type="VARCHAR(50)" null="false"/>
            <column name="message" type="TEXT" null="false"/>
            <column name="context" type="JSON"/>
            <column name="user_id" type="INT UNSIGNED"/>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_level" columns="level"/>
            <index name="idx_channel" columns="channel"/>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_created_at" columns="created_at"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="SET NULL"/>
        </foreignKeys>
    </table>

    <!-- Audit Log Table -->
    <table name="audit_log">
        <description>Audit trail for compliance</description>
        <columns>
            <column name="id" type="BIGINT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED"/>
            <column name="action" type="VARCHAR(100)" null="false"/>
            <column name="entity_type" type="VARCHAR(100)"/>
            <column name="entity_id" type="INT UNSIGNED"/>
            <column name="old_values" type="JSON"/>
            <column name="new_values" type="JSON"/>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_action" columns="action"/>
            <index name="idx_entity" columns="entity_type,entity_id"/>
            <index name="idx_created_at" columns="created_at"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="SET NULL"/>
        </foreignKeys>
    </table>
</database>
