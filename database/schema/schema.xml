<?xml version="1.0" encoding="UTF-8"?>
<database>
    <metadata>
        <name>ISER Authentication System Database Schema</name>
        <version>1.0.0</version>
        <charset>utf8mb4</charset>
        <collation>utf8mb4_unicode_ci</collation>
        <engine>InnoDB</engine>
    </metadata>

    <!-- Core Configuration Table - NORMALIZED -->
    <table name="config">
        <description>System configuration (consolidated from config + report_config)</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="config_key" type="VARCHAR(100)" null="false" unique="true"/>
            <column name="config_value" type="TEXT"/>
            <column name="config_type" type="ENUM('string','int','bool','json')" default="string"/>
            <column name="category" type="VARCHAR(50)" default="general"/>
            <column name="description" type="VARCHAR(255)"/>
            <column name="is_public" type="BOOLEAN" default="false"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_config_key" columns="config_key"/>
            <index name="idx_category" columns="category"/>
        </indexes>
        <data>
            <!-- General App Settings -->
            <row>
                <config_key>app.name</config_key>
                <config_value>ISER Authentication System</config_value>
                <config_type>string</config_type>
                <category>app</category>
                <description>Application name</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>app.version</config_key>
                <config_value>1.0.0</config_value>
                <config_type>string</config_type>
                <category>app</category>
                <description>Application version</description>
                <is_public>1</is_public>
            </row>

            <!-- Security Settings -->
            <row>
                <config_key>security.password_min_length</config_key>
                <config_value>8</config_value>
                <config_type>int</config_type>
                <category>security</category>
                <description>Minimum password length</description>
                <is_public>0</is_public>
            </row>
            <row>
                <config_key>security.max_login_attempts</config_key>
                <config_value>5</config_value>
                <config_type>int</config_type>
                <category>security</category>
                <description>Maximum login attempts</description>
                <is_public>0</is_public>
            </row>
            <row>
                <config_key>security.lockout_duration</config_key>
                <config_value>900</config_value>
                <config_type>int</config_type>
                <category>security</category>
                <description>Lockout duration in seconds</description>
                <is_public>0</is_public>
            </row>

            <!-- Report Settings (consolidated from report_config table) -->
            <row>
                <config_key>report.retention_days</config_key>
                <config_value>90</config_value>
                <config_type>int</config_type>
                <category>reports</category>
                <description>Log retention days</description>
                <is_public>0</is_public>
            </row>
            <row>
                <config_key>report.max_export_rows</config_key>
                <config_value>10000</config_value>
                <config_type>int</config_type>
                <category>reports</category>
                <description>Maximum export rows</description>
                <is_public>0</is_public>
            </row>
            <row>
                <config_key>report.default_format</config_key>
                <config_value>pdf</config_value>
                <config_type>string</config_type>
                <category>reports</category>
                <description>Default report format</description>
                <is_public>0</is_public>
            </row>

            <!-- Theme Settings - FASE 4 -->
            <row>
                <config_key>theme.primary_color</config_key>
                <config_value>#1B9E88</config_value>
                <config_type>string</config_type>
                <category>theme</category>
                <description>Primary theme color</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>theme.secondary_color</config_key>
                <config_value>#F4C430</config_value>
                <config_type>string</config_type>
                <category>theme</category>
                <description>Secondary theme color</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>theme.font_headings</config_key>
                <config_value>Inter</config_value>
                <config_type>string</config_type>
                <category>theme</category>
                <description>Font for headings</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>theme.font_body</config_key>
                <config_value>Inter</config_value>
                <config_type>string</config_type>
                <category>theme</category>
                <description>Font for body text</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>theme.sidebar_position</config_key>
                <config_value>left</config_value>
                <config_type>string</config_type>
                <category>theme</category>
                <description>Sidebar position (left/right)</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>theme.container_width</config_key>
                <config_value>boxed-xl</config_value>
                <config_type>string</config_type>
                <category>theme</category>
                <description>Container width (fluid/boxed-lg/boxed-xl)</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>theme.dark_mode_enabled</config_key>
                <config_value>true</config_value>
                <config_type>bool</config_type>
                <category>theme</category>
                <description>Enable dark mode feature</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>theme.dark_mode_auto</config_key>
                <config_value>false</config_value>
                <config_type>bool</config_type>
                <category>theme</category>
                <description>Auto dark mode based on time</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>theme.logo_path</config_key>
                <config_value>/assets/images/logo.png</config_value>
                <config_type>string</config_type>
                <category>theme</category>
                <description>Path to main logo</description>
                <is_public>1</is_public>
            </row>
            <row>
                <config_key>theme.app_name</config_key>
                <config_value>ISER Auth System</config_value>
                <config_type>string</config_type>
                <category>theme</category>
                <description>Application name displayed in UI</description>
                <is_public>1</is_public>
            </row>
        </data>
    </table>

    <!-- Users Table - NORMALIZED -->
    <table name="users">
        <description>System users (3FN normalized - security and login history in separate tables)</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="username" type="VARCHAR(50)" null="false" unique="true"/>
            <column name="email" type="VARCHAR(255)" null="false" unique="true"/>
            <column name="password" type="VARCHAR(255)" null="false"/>
            <column name="first_name" type="VARCHAR(100)"/>
            <column name="last_name" type="VARCHAR(100)"/>
            <column name="status" type="ENUM('active','inactive','suspended','pending')" default="active"/>
            <column name="email_verified" type="BOOLEAN" default="false"/>
            <column name="email_verification_token" type="VARCHAR(64)"/>
            <column name="email_verification_expires" type="INT UNSIGNED"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
            <column name="deleted_at" type="INT UNSIGNED"/>
        </columns>
        <indexes>
            <index name="idx_username" columns="username"/>
            <index name="idx_email" columns="email"/>
            <index name="idx_status" columns="status"/>
            <index name="idx_email_verification_token" columns="email_verification_token"/>
            <index name="idx_deleted_at" columns="deleted_at"/>
        </indexes>
    </table>

    <!-- Password Reset Tokens Table - NEW (Normalized from users) -->
    <table name="password_reset_tokens">
        <description>Password reset tokens (separated from users for better normalization)</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false"/>
            <column name="token" type="VARCHAR(64)" null="false" unique="true"/>
            <column name="expires_at" type="INT UNSIGNED" null="false"/>
            <column name="used_at" type="INT UNSIGNED"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_token" columns="token"/>
            <index name="idx_expires_at" columns="expires_at"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Login Attempts Table - NORMALIZED -->
    <table name="login_attempts">
        <description>Login attempt tracking (with optional FK to users)</description>
        <columns>
            <column name="id" type="BIGINT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED"/>
            <column name="username" type="VARCHAR(255)" null="false"/>
            <column name="ip_address" type="VARCHAR(45)" null="false"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="success" type="BOOLEAN" default="false" null="false"/>
            <column name="attempted_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_username" columns="username"/>
            <index name="idx_ip_address" columns="ip_address"/>
            <index name="idx_attempted_at" columns="attempted_at"/>
            <index name="idx_success" columns="success"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="SET NULL"/>
        </foreignKeys>
    </table>

    <!-- User Profiles Table - NORMALIZED (1:1 relationship with users) -->
    <table name="user_profiles">
        <description>User profile information (3FN normalized - preferences in separate table)</description>
        <columns>
            <column name="user_id" type="INT UNSIGNED" primary="true"/>
            <column name="phone" type="VARCHAR(20)"/>
            <column name="mobile" type="VARCHAR(20)"/>
            <column name="address" type="TEXT"/>
            <column name="city" type="VARCHAR(100)"/>
            <column name="state" type="VARCHAR(100)"/>
            <column name="country" type="VARCHAR(100)"/>
            <column name="postal_code" type="VARCHAR(20)"/>
            <column name="avatar_url" type="VARCHAR(255)"/>
            <column name="bio" type="TEXT"/>
            <column name="metadata" type="JSON"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Login History Table - FASE 6 (3FN Normalization) -->
    <table name="login_history">
        <description>Complete login history tracking (normalized from users.last_login_*)</description>
        <columns>
            <column name="id" type="BIGINT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false"/>
            <column name="ip_address" type="VARCHAR(45)" null="false"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="login_at" type="INT UNSIGNED" null="false"/>
            <column name="logout_at" type="INT UNSIGNED"/>
            <column name="session_id" type="VARCHAR(128)"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_login_at" columns="login_at"/>
            <index name="idx_session_id" columns="session_id"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Account Security Table - FASE 6 (3FN Normalization) -->
    <table name="account_security">
        <description>User account security state (normalized from users.failed_login_*, locked_until)</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false" unique="true"/>
            <column name="failed_login_attempts" type="INT UNSIGNED" default="0" null="false"/>
            <column name="locked_until" type="INT UNSIGNED"/>
            <column name="last_failed_attempt_at" type="INT UNSIGNED"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_locked_until" columns="locked_until"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- User Preferences Table - FASE 6 (3FN Normalization) -->
    <table name="user_preferences">
        <description>Extensible user preferences (normalized from user_profiles.timezone, locale)</description>
        <columns>
            <column name="id" type="BIGINT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false"/>
            <column name="preference_key" type="VARCHAR(100)" null="false"/>
            <column name="preference_value" type="TEXT"/>
            <column name="preference_type" type="ENUM('string','int','bool','json')" default="string"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_preference_key" columns="preference_key"/>
            <index name="idx_user_preference" columns="user_id,preference_key" unique="true"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Roles Table -->
    <table name="roles">
        <description>User roles</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="name" type="VARCHAR(50)" null="false" unique="true"/>
            <column name="slug" type="VARCHAR(50)" null="false" unique="true"/>
            <column name="description" type="TEXT"/>
            <column name="is_system" type="BOOLEAN" default="false"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_slug" columns="slug"/>
            <index name="idx_is_system" columns="is_system"/>
        </indexes>
        <data>
            <row>
                <name>Administrador</name>
                <slug>admin</slug>
                <description>System administrator with full access</description>
                <is_system>1</is_system>
            </row>
            <row>
                <name>Moderador</name>
                <slug>moderator</slug>
                <description>Moderator with limited permissions</description>
                <is_system>1</is_system>
            </row>
            <row>
                <name>Usuario</name>
                <slug>user</slug>
                <description>Standard system user</description>
                <is_system>1</is_system>
            </row>
            <row>
                <name>Invitado</name>
                <slug>guest</slug>
                <description>Guest user with limited access</description>
                <is_system>1</is_system>
            </row>
        </data>
    </table>

    <!-- Permissions Table -->
    <table name="permissions">
        <description>System permissions</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="name" type="VARCHAR(100)" null="false" unique="true"/>
            <column name="slug" type="VARCHAR(100)" null="false" unique="true"/>
            <column name="description" type="TEXT"/>
            <column name="module" type="VARCHAR(50)"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_slug" columns="slug"/>
            <index name="idx_module" columns="module"/>
        </indexes>
        <data>
            <!-- Permisos granulares: Usuarios -->
            <row>
                <name>Ver Usuarios</name>
                <slug>users.view</slug>
                <description>Permite ver la lista de usuarios del sistema</description>
                <module>users</module>
            </row>
            <row>
                <name>Crear Usuarios</name>
                <slug>users.create</slug>
                <description>Permite crear nuevos usuarios en el sistema</description>
                <module>users</module>
            </row>
            <row>
                <name>Editar Usuarios</name>
                <slug>users.update</slug>
                <description>Permite editar información de usuarios existentes</description>
                <module>users</module>
            </row>
            <row>
                <name>Eliminar Usuarios</name>
                <slug>users.delete</slug>
                <description>Permite eliminar usuarios del sistema (soft delete)</description>
                <module>users</module>
            </row>
            <row>
                <name>Restaurar Usuarios</name>
                <slug>users.restore</slug>
                <description>Permite restaurar usuarios eliminados</description>
                <module>users</module>
            </row>
            <row>
                <name>Asignar Roles a Usuarios</name>
                <slug>users.assign_roles</slug>
                <description>Permite asignar o quitar roles de los usuarios</description>
                <module>users</module>
            </row>
            <row>
                <name>Ver Perfil de Usuario</name>
                <slug>users.view_profile</slug>
                <description>Permite ver el perfil detallado de usuarios</description>
                <module>users</module>
            </row>

            <!-- Permisos granulares: Roles -->
            <row>
                <name>Ver Roles</name>
                <slug>roles.view</slug>
                <description>Permite ver la lista de roles del sistema</description>
                <module>roles</module>
            </row>
            <row>
                <name>Crear Roles</name>
                <slug>roles.create</slug>
                <description>Permite crear nuevos roles en el sistema</description>
                <module>roles</module>
            </row>
            <row>
                <name>Editar Roles</name>
                <slug>roles.update</slug>
                <description>Permite editar roles existentes</description>
                <module>roles</module>
            </row>
            <row>
                <name>Eliminar Roles</name>
                <slug>roles.delete</slug>
                <description>Permite eliminar roles del sistema</description>
                <module>roles</module>
            </row>
            <row>
                <name>Asignar Permisos a Roles</name>
                <slug>roles.assign_permissions</slug>
                <description>Permite asignar o quitar permisos de los roles</description>
                <module>roles</module>
            </row>

            <!-- Permisos granulares: Permisos -->
            <row>
                <name>Ver Permisos</name>
                <slug>permissions.view</slug>
                <description>Permite ver la lista de permisos del sistema</description>
                <module>permissions</module>
            </row>
            <row>
                <name>Crear Permisos</name>
                <slug>permissions.create</slug>
                <description>Permite crear nuevos permisos en el sistema</description>
                <module>permissions</module>
            </row>
            <row>
                <name>Editar Permisos</name>
                <slug>permissions.update</slug>
                <description>Permite editar permisos existentes</description>
                <module>permissions</module>
            </row>
            <row>
                <name>Eliminar Permisos</name>
                <slug>permissions.delete</slug>
                <description>Permite eliminar permisos del sistema</description>
                <module>permissions</module>
            </row>

            <!-- Permisos granulares: Dashboard -->
            <row>
                <name>Ver Dashboard</name>
                <slug>dashboard.view</slug>
                <description>Permite acceder al panel de administración</description>
                <module>dashboard</module>
            </row>
            <row>
                <name>Ver Estadísticas</name>
                <slug>dashboard.stats</slug>
                <description>Permite ver estadísticas del sistema</description>
                <module>dashboard</module>
            </row>
            <row>
                <name>Ver Gráficas</name>
                <slug>dashboard.charts</slug>
                <description>Permite ver gráficas y reportes visuales</description>
                <module>dashboard</module>
            </row>

            <!-- Permisos granulares: Configuración -->
            <row>
                <name>Ver Configuración</name>
                <slug>settings.view</slug>
                <description>Permite ver la configuración del sistema</description>
                <module>settings</module>
            </row>
            <row>
                <name>Editar Configuración</name>
                <slug>settings.update</slug>
                <description>Permite modificar la configuración del sistema</description>
                <module>settings</module>
            </row>
            <row>
                <name>Gestionar Configuración Crítica</name>
                <slug>settings.critical</slug>
                <description>Permite modificar configuraciones críticas del sistema</description>
                <module>settings</module>
            </row>

            <!-- Permisos granulares: Logs -->
            <row>
                <name>Ver Logs</name>
                <slug>logs.view</slug>
                <description>Permite ver los registros de actividad del sistema</description>
                <module>logs</module>
            </row>
            <row>
                <name>Eliminar Logs</name>
                <slug>logs.delete</slug>
                <description>Permite eliminar registros de actividad</description>
                <module>logs</module>
            </row>
            <row>
                <name>Exportar Logs</name>
                <slug>logs.export</slug>
                <description>Permite exportar registros de actividad</description>
                <module>logs</module>
            </row>

            <!-- Permisos granulares: Auditoría -->
            <row>
                <name>Ver Auditoría</name>
                <slug>audit.view</slug>
                <description>Permite ver la pista de auditoría del sistema</description>
                <module>audit</module>
            </row>
            <row>
                <name>Exportar Auditoría</name>
                <slug>audit.export</slug>
                <description>Permite exportar registros de auditoría</description>
                <module>audit</module>
            </row>

            <!-- Permisos granulares: Reportes -->
            <row>
                <name>Ver Reportes</name>
                <slug>reports.view</slug>
                <description>Permite ver reportes del sistema</description>
                <module>reports</module>
            </row>
            <row>
                <name>Generar Reportes</name>
                <slug>reports.generate</slug>
                <description>Permite generar nuevos reportes</description>
                <module>reports</module>
            </row>
            <row>
                <name>Exportar Reportes</name>
                <slug>reports.export</slug>
                <description>Permite exportar reportes en diferentes formatos</description>
                <module>reports</module>
            </row>

            <!-- Permisos granulares: Sesiones -->
            <row>
                <name>Ver Sesiones</name>
                <slug>sessions.view</slug>
                <description>Permite ver sesiones activas del sistema</description>
                <module>sessions</module>
            </row>
            <row>
                <name>Cerrar Sesiones</name>
                <slug>sessions.terminate</slug>
                <description>Permite cerrar sesiones de otros usuarios</description>
                <module>sessions</module>
            </row>

            <!-- Permisos granulares: Cola de Correos (FASE 8) -->
            <row>
                <name>Ver Cola de Correos</name>
                <slug>email_queue.view</slug>
                <description>Permite ver la cola de correos del sistema</description>
                <module>email_queue</module>
            </row>
            <row>
                <name>Reintentar Envío de Correos</name>
                <slug>email_queue.retry</slug>
                <description>Permite reintentar el envío de correos fallidos</description>
                <module>email_queue</module>
            </row>
            <row>
                <name>Eliminar Correos de la Cola</name>
                <slug>email_queue.delete</slug>
                <description>Permite eliminar correos de la cola de envío</description>
                <module>email_queue</module>
            </row>
            <row>
                <name>Limpiar Cola de Correos</name>
                <slug>email_queue.clear</slug>
                <description>Permite limpiar correos antiguos de la cola</description>
                <module>email_queue</module>
            </row>
        </data>
    </table>

    <!-- User Roles Table -->
    <table name="user_roles">
        <description>User to roles relationship</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false"/>
            <column name="role_id" type="INT UNSIGNED" null="false"/>
            <column name="assigned_at" type="INT UNSIGNED" null="false"/>
            <column name="assigned_by" type="INT UNSIGNED"/>
            <column name="expires_at" type="INT UNSIGNED"/>
        </columns>
        <indexes>
            <index name="unique_user_role" columns="user_id,role_id" unique="true"/>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_role_id" columns="role_id"/>
            <index name="idx_assigned_by" columns="assigned_by"/>
            <index name="idx_expires_at" columns="expires_at"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
            <foreignKey column="role_id" references="roles(id)" onDelete="CASCADE"/>
            <foreignKey column="assigned_by" references="users(id)" onDelete="SET NULL"/>
        </foreignKeys>
    </table>

    <!-- Role Permissions Table -->
    <table name="role_permissions">
        <description>Role to permissions relationship</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="role_id" type="INT UNSIGNED" null="false"/>
            <column name="permission_id" type="INT UNSIGNED" null="false"/>
            <column name="granted_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="unique_role_permission" columns="role_id,permission_id" unique="true"/>
            <index name="idx_role_id" columns="role_id"/>
            <index name="idx_permission_id" columns="permission_id"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="role_id" references="roles(id)" onDelete="CASCADE"/>
            <foreignKey column="permission_id" references="permissions(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Sessions Table -->
    <table name="sessions">
        <description>User sessions</description>
        <columns>
            <column name="id" type="VARCHAR(128)" primary="true"/>
            <column name="user_id" type="INT UNSIGNED"/>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="payload" type="TEXT"/>
            <column name="last_activity" type="INT UNSIGNED" null="false"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_last_activity" columns="last_activity"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- JWT Tokens Table -->
    <table name="jwt_tokens">
        <description>JWT tokens</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false"/>
            <column name="token_id" type="VARCHAR(64)" null="false" unique="true"/>
            <column name="token_hash" type="VARCHAR(64)" null="false"/>
            <column name="type" type="ENUM('access','refresh')" default="access"/>
            <column name="expires_at" type="INT UNSIGNED" null="false"/>
            <column name="revoked" type="BOOLEAN" default="false"/>
            <column name="revoked_at" type="INT UNSIGNED"/>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_token_id" columns="token_id"/>
            <index name="idx_expires_at" columns="expires_at"/>
            <index name="idx_revoked" columns="revoked"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- MFA Table -->
    <table name="user_mfa">
        <description>Multi-factor authentication</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED" null="false"/>
            <column name="method" type="ENUM('totp','sms','email','backup_codes')" null="false"/>
            <column name="secret" type="VARCHAR(255)"/>
            <column name="enabled" type="BOOLEAN" default="false"/>
            <column name="verified" type="BOOLEAN" default="false"/>
            <column name="backup_codes" type="JSON"/>
            <column name="phone" type="VARCHAR(20)"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="unique_user_method" columns="user_id,method" unique="true"/>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_enabled" columns="enabled"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Logs Table -->
    <table name="logs">
        <description>System logs</description>
        <columns>
            <column name="id" type="BIGINT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="level" type="VARCHAR(20)" null="false"/>
            <column name="channel" type="VARCHAR(50)" null="false"/>
            <column name="message" type="TEXT" null="false"/>
            <column name="context" type="JSON"/>
            <column name="user_id" type="INT UNSIGNED"/>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_level" columns="level"/>
            <index name="idx_channel" columns="channel"/>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_created_at" columns="created_at"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="SET NULL"/>
        </foreignKeys>
    </table>

    <!-- Audit Log Table -->
    <table name="audit_log">
        <description>Audit trail</description>
        <columns>
            <column name="id" type="BIGINT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="user_id" type="INT UNSIGNED"/>
            <column name="action" type="VARCHAR(100)" null="false"/>
            <column name="entity_type" type="VARCHAR(100)"/>
            <column name="entity_id" type="INT UNSIGNED"/>
            <column name="old_values" type="JSON"/>
            <column name="new_values" type="JSON"/>
            <column name="ip_address" type="VARCHAR(45)"/>
            <column name="user_agent" type="VARCHAR(255)"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_user_id" columns="user_id"/>
            <index name="idx_action" columns="action"/>
            <index name="idx_entity" columns="entity_type,entity_id"/>
            <index name="idx_created_at" columns="created_at"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="user_id" references="users(id)" onDelete="SET NULL"/>
        </foreignKeys>
    </table>

    <!-- FASE 2: PLUGIN SYSTEM TABLES -->

    <!-- Plugins Table -->
    <table name="plugins">
        <description>Installed plugins registry</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="slug" type="VARCHAR(100)" null="false" unique="true"/>
            <column name="name" type="VARCHAR(200)" null="false"/>
            <column name="type" type="ENUM('tools','auth','themes','reports','modules','integrations')" null="false"/>
            <column name="version" type="VARCHAR(20)" null="false"/>
            <column name="description" type="TEXT"/>
            <column name="author" type="VARCHAR(100)"/>
            <column name="author_url" type="VARCHAR(255)"/>
            <column name="plugin_url" type="VARCHAR(255)"/>
            <column name="path" type="VARCHAR(255)" null="false"/>
            <column name="is_core" type="BOOLEAN" default="false"/>
            <column name="priority" type="INT" default="10"/>
            <column name="manifest" type="TEXT"/>
            <column name="enabled" type="BOOLEAN" default="false"/>
            <column name="activated_at" type="INT UNSIGNED"/>
            <column name="installed_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_slug" columns="slug"/>
            <index name="idx_type" columns="type"/>
            <index name="idx_enabled" columns="enabled"/>
            <index name="idx_is_core" columns="is_core"/>
            <index name="idx_priority" columns="priority"/>
        </indexes>
    </table>

    <!-- Plugin Dependencies Table -->
    <table name="plugin_dependencies">
        <description>Plugin dependency relationships</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="plugin_id" type="INT UNSIGNED" null="false"/>
            <column name="depends_on_slug" type="VARCHAR(100)" null="false"/>
            <column name="min_version" type="VARCHAR(20)"/>
        </columns>
        <indexes>
            <index name="idx_plugin_id" columns="plugin_id"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="plugin_id" references="plugins(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Plugin Hooks Table -->
    <table name="plugin_hooks">
        <description>Plugin hook registrations</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="plugin_id" type="INT UNSIGNED" null="false"/>
            <column name="hook_name" type="VARCHAR(100)" null="false"/>
            <column name="callback_class" type="VARCHAR(255)" null="false"/>
            <column name="callback_method" type="VARCHAR(100)" null="false"/>
            <column name="priority" type="INT" default="10"/>
        </columns>
        <indexes>
            <index name="idx_plugin_id" columns="plugin_id"/>
            <index name="idx_hook_name" columns="hook_name"/>
            <index name="idx_priority" columns="priority"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="plugin_id" references="plugins(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Plugin Settings Table -->
    <table name="plugin_settings">
        <description>Plugin configuration settings</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="plugin_id" type="INT UNSIGNED" null="false"/>
            <column name="setting_key" type="VARCHAR(100)" null="false"/>
            <column name="setting_value" type="TEXT"/>
            <column name="setting_type" type="ENUM('string','int','bool','json')" default="string"/>
        </columns>
        <indexes>
            <index name="idx_plugin_setting" columns="plugin_id,setting_key" unique="true"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="plugin_id" references="plugins(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Plugin Assets Table -->
    <table name="plugin_assets">
        <description>Plugin static assets registry</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="plugin_id" type="INT UNSIGNED" null="false"/>
            <column name="asset_type" type="ENUM('css','js','image','font')" null="false"/>
            <column name="asset_path" type="VARCHAR(255)" null="false"/>
            <column name="load_order" type="INT" default="10"/>
            <column name="is_active" type="BOOLEAN" default="true"/>
        </columns>
        <indexes>
            <index name="idx_plugin_id" columns="plugin_id"/>
            <index name="idx_asset_type" columns="asset_type"/>
        </indexes>
        <foreignKeys>
            <foreignKey column="plugin_id" references="plugins(id)" onDelete="CASCADE"/>
        </foreignKeys>
    </table>

    <!-- Email Queue Table - FASE 8 -->
    <table name="email_queue">
        <description>Email queue management for asynchronous email delivery</description>
        <columns>
            <column name="id" type="INT UNSIGNED" autoincrement="true" primary="true"/>
            <column name="to_email" type="VARCHAR(255)" null="false"/>
            <column name="subject" type="VARCHAR(255)" null="false"/>
            <column name="body" type="LONGTEXT" null="false"/>
            <column name="status" type="ENUM('pending','sent','failed')" default="pending" null="false"/>
            <column name="attempts" type="INT UNSIGNED" default="0" null="false"/>
            <column name="last_attempt_at" type="INT UNSIGNED"/>
            <column name="error_message" type="TEXT"/>
            <column name="created_at" type="INT UNSIGNED" null="false"/>
            <column name="updated_at" type="INT UNSIGNED" null="false"/>
        </columns>
        <indexes>
            <index name="idx_status" columns="status"/>
            <index name="idx_to_email" columns="to_email"/>
            <index name="idx_created_at" columns="created_at"/>
            <index name="idx_last_attempt_at" columns="last_attempt_at"/>
            <index name="idx_pending_queue" columns="status,created_at" unique="false"/>
        </indexes>
    </table>
</database>
