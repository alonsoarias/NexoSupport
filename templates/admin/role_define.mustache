{{!
    Role Capabilities Definition Template

    Context:
    * role_id - Role ID
    * role_name - Role name
    * role_shortname - Role shortname
    * role_description - Role description
    * components - Array of capability components
    * success - Success message
    * sesskey - Session key
}}
{{> core/header}}

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0;
    }

    .role-info {
        background: var(--bg-tertiary);
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--primary-color);
    }

    .role-info p {
        margin: 0.25rem 0;
        color: var(--text-secondary);
    }

    .role-info strong {
        color: var(--text-primary);
    }

    .alert {
        padding: 1rem 1.25rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .alert-success {
        background: rgba(16, 185, 129, 0.1);
        border-left: 4px solid var(--success);
        color: var(--success);
    }

    .alert-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .legend {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
        padding: 1rem 1.25rem;
        background: var(--bg-tertiary);
        border-radius: 0.5rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        color: var(--text-secondary);
    }

    .legend-color {
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 0.25rem;
    }

    .component-section {
        margin-bottom: 1.5rem;
        background: var(--bg-primary);
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .component-title {
        background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
        color: white;
        padding: 1rem 1.25rem;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all var(--transition-fast);
    }

    .component-title:hover {
        filter: brightness(1.1);
    }

    .component-title i {
        transition: transform var(--transition-fast);
    }

    .component-title.collapsed i {
        transform: rotate(-90deg);
    }

    .capability-list {
        border-top: 1px solid var(--border-color);
    }

    .capability-row {
        padding: 0.875rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        transition: background var(--transition-fast);
    }

    .capability-row:last-child {
        border-bottom: none;
    }

    .capability-row:hover {
        background: var(--bg-secondary);
    }

    .capability-name {
        flex: 1;
        font-family: 'Courier New', monospace;
        font-size: 0.8125rem;
        color: var(--text-primary);
    }

    .capability-type {
        padding: 0.25rem 0.625rem;
        background: var(--bg-tertiary);
        border-radius: 0.25rem;
        font-size: 0.6875rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .permission-selector {
        display: flex;
        gap: 0.25rem;
    }

    .permission-btn {
        padding: 0.5rem 0.75rem;
        border: 2px solid var(--border-color);
        background: var(--bg-primary);
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all var(--transition-fast);
        color: var(--text-secondary);
    }

    .permission-btn:hover {
        border-color: var(--primary-color);
    }

    .permission-btn.active-inherit {
        background: #6b7280;
        color: white;
        border-color: #6b7280;
    }

    .permission-btn.active-allow {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }

    .permission-btn.active-prevent {
        background: var(--warning);
        color: #1f2937;
        border-color: var(--warning);
    }

    .permission-btn.active-prohibit {
        background: var(--error);
        color: white;
        border-color: var(--error);
    }

    .form-actions {
        position: sticky;
        bottom: 0;
        background: var(--bg-primary);
        padding: 1.25rem;
        border-top: 1px solid var(--border-color);
        margin-top: 2rem;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 100;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
        color: white;
        text-decoration: none;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-size: 0.9375rem;
        font-weight: 500;
        transition: all var(--transition-fast);
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary {
        background: var(--text-secondary);
    }

    .breadcrumb {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: var(--text-muted);
    }

    .breadcrumb a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    @media (max-width: 768px) {
        .capability-row {
            flex-direction: column;
            align-items: flex-start;
        }

        .permission-selector {
            margin-top: 0.75rem;
            width: 100%;
            justify-content: flex-start;
        }

        .legend {
            flex-direction: column;
            gap: 0.75rem;
        }
    }
</style>

<div class="breadcrumb">
    <a href="/admin">{{#str}}administration,core{{/str}}</a>
    <span>/</span>
    <a href="/admin/roles/">{{#str}}roles,core{{/str}}</a>
    <span>/</span>
    <a href="/admin/roles/edit.php?id={{role_id}}">{{role_name}}</a>
    <span>/</span>
    <span>{{#str}}definepermissions,core{{/str}}</span>
</div>

<div class="page-header">
    <h1><i class="fas fa-key"></i> {{#str}}definepermissions,core{{/str}}</h1>
</div>

<div class="role-info">
    <p><strong><i class="fas fa-shield-alt"></i> {{#str}}role,core{{/str}}:</strong> {{role_name}} ({{role_shortname}})</p>
    {{#role_description}}
    <p><strong><i class="fas fa-info-circle"></i> {{#str}}description,core{{/str}}:</strong> {{role_description}}</p>
    {{/role_description}}
</div>

{{#success}}
<div class="alert alert-success">
    <i class="fas fa-check-circle alert-icon"></i>
    <div>{{{success}}}</div>
</div>
{{/success}}

<div class="legend">
    <div class="legend-item">
        <div class="legend-color" style="background: #6b7280;"></div>
        <span><strong>{{#str}}inherit,core{{/str}} (0):</strong> {{#str}}inheritdesc,core{{/str}}</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: var(--success);"></div>
        <span><strong>{{#str}}allow,core{{/str}} (1):</strong> {{#str}}allowdesc,core{{/str}}</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: var(--warning);"></div>
        <span><strong>{{#str}}prevent,core{{/str}} (-1):</strong> {{#str}}preventdesc,core{{/str}}</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: var(--error);"></div>
        <span><strong>{{#str}}prohibit,core{{/str}} (-1000):</strong> {{#str}}prohibitdesc,core{{/str}}</span>
    </div>
</div>

<form method="POST" id="capsForm">
    <input type="hidden" name="sesskey" value="{{sesskey}}">

    {{#components}}
    <div class="component-section">
        <div class="component-title" onclick="toggleComponent('{{component_name}}')">
            <span><i class="fas fa-puzzle-piece"></i> {{component_name}} ({{capability_count}} capabilities)</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div class="capability-list" id="component-{{component_name}}">
            {{#capabilities}}
            <div class="capability-row">
                <div class="capability-name">{{cap_name}}</div>
                <div class="capability-type">{{cap_type}}</div>
                <div class="permission-selector">
                    <button type="button"
                            class="permission-btn {{#is_inherit}}active-inherit{{/is_inherit}}"
                            onclick="setPerm('{{field_name}}', 0, this)">
                        {{#str}}inherit,core{{/str}}
                    </button>
                    <button type="button"
                            class="permission-btn {{#is_allow}}active-allow{{/is_allow}}"
                            onclick="setPerm('{{field_name}}', 1, this)">
                        {{#str}}allow,core{{/str}}
                    </button>
                    <button type="button"
                            class="permission-btn {{#is_prevent}}active-prevent{{/is_prevent}}"
                            onclick="setPerm('{{field_name}}', -1, this)">
                        {{#str}}prevent,core{{/str}}
                    </button>
                    <button type="button"
                            class="permission-btn {{#is_prohibit}}active-prohibit{{/is_prohibit}}"
                            onclick="setPerm('{{field_name}}', -1000, this)">
                        {{#str}}prohibit,core{{/str}}
                    </button>
                    <input type="hidden" name="{{field_name}}" id="{{field_name}}" value="{{current_perm}}">
                </div>
            </div>
            {{/capabilities}}
        </div>
    </div>
    {{/components}}

    <div class="form-actions">
        <button type="submit" class="btn">
            <i class="fas fa-save"></i> {{#str}}savepermissions,core{{/str}}
        </button>
        <a href="/admin/roles/" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> {{#str}}backtoroles,core{{/str}}
        </a>
        <a href="/admin/roles/edit.php?id={{role_id}}" class="btn btn-secondary">
            <i class="fas fa-edit"></i> {{#str}}editrole,core{{/str}}
        </a>
    </div>
</form>

<script>
    function setPerm(fieldName, value, button) {
        // Update hidden field
        document.getElementById(fieldName).value = value;

        // Get all buttons in the same row
        const row = button.closest('.capability-row');
        const buttons = row.querySelectorAll('.permission-btn');

        // Remove all active classes
        buttons.forEach(btn => {
            btn.classList.remove('active-inherit', 'active-allow', 'active-prevent', 'active-prohibit');
        });

        // Add active class to clicked button
        if (value == 0) {
            button.classList.add('active-inherit');
        } else if (value == 1) {
            button.classList.add('active-allow');
        } else if (value == -1) {
            button.classList.add('active-prevent');
        } else if (value == -1000) {
            button.classList.add('active-prohibit');
        }
    }

    function toggleComponent(component) {
        const element = document.getElementById('component-' + component);
        const title = element.previousElementSibling;

        if (element.style.display === 'none') {
            element.style.display = 'block';
            title.classList.remove('collapsed');
        } else {
            element.style.display = 'none';
            title.classList.add('collapsed');
        }
    }
</script>

{{> core/footer}}
