# Correcciones de Errores - 23 de Noviembre 2025

## Resumen

Se corrigieron dos errores críticos que impedían el correcto funcionamiento del sistema:

1. **Error de tipo en `admin_setting_configtextarea`**
2. **Método indefinido `set_url()` en objeto `$PAGE`**

---

## Error 1: TypeError en admin_setting_configtextarea

### Síntomas

```
PHP Fatal error: Uncaught TypeError: core\admin\admin_setting_configtextarea::__construct(): 
Argument #5 ($rows) must be of type int, string given, called in 
C:\MAMP\htdocs\NexoSupport\admin\settings\general.php on line 42
```

### Causa

En el archivo `admin/settings/general.php`, línea 42, se estaban pasando los argumentos en orden incorrecto al constructor de `admin_setting_configtextarea`:

```php
// ❌ INCORRECTO (antes)
$settings->add(new \core\admin\admin_setting_configtextarea(
    'sitedescription',
    get_string('sitedescription', 'core'),
    get_string('sitedescriptionhelp', 'core'),
    '',           // $defaultsetting (string) ✓
    PARAM_TEXT,   // ❌ Esto debería ser $rows (int), pero es string
    60,           // $cols (int) en posición incorrecta
    3             // $rows (int) en posición incorrecta
));
```

El constructor espera:

```php
public function __construct(
    string $name,
    string $visiblename,
    string $description,
    string $defaultsetting = '',
    int $rows = 5,              // Posición 5: debe ser int
    int $cols = 50              // Posición 6: debe ser int
)
```

### Solución

Se corrigió el orden de los parámetros, eliminando `PARAM_TEXT` (que no es necesario) y pasando correctamente `$rows` y `$cols`:

```php
// ✅ CORRECTO (después)
$settings->add(new \core\admin\admin_setting_configtextarea(
    'sitedescription',
    get_string('sitedescription', 'core'),
    get_string('sitedescriptionhelp', 'core'),
    '',    // $defaultsetting (string)
    3,     // $rows (int)
    60     // $cols (int)
));
```

### Archivo modificado

- **Archivo:** `admin/settings/general.php`
- **Línea:** 42
- **Commit:** [8878a48](https://github.com/alonsoarias/NexoSupport/commit/8878a4894b99b93d2533df0f4685e52f0c9a1210)

---

## Error 2: Call to undefined method stdClass::set_url()

### Síntomas

```
Fatal error: Uncaught Error: Call to undefined method stdClass::set_url() in 
C:\MAMP\htdocs\NexoSupport\report\performance\index.php:37
```

### Causa

El objeto global `$PAGE` se estaba inicializando como un `stdClass` simple en `lib/setup.php`, pero el código en `report/performance/index.php` intentaba llamar al método `set_url()`:

```php
// En lib/setup.php (antes)
global $PAGE;
$PAGE = new stdClass();  // ❌ No tiene métodos

// En report/performance/index.php:37
$PAGE->set_url($url);    // ❌ Error: método no existe
```

### Solución

Se implementó una nueva clase `\core\page_manager` que proporciona los métodos necesarios para manejar información de páginas:

#### 1. Nueva clase `lib/classes/page_manager.php`

```php
namespace core;

class page_manager {
    protected $url = null;
    protected $title = '';
    protected $context = null;
    protected $pagelayout = 'standard';
    protected $data = [];

    public function set_url($url): void { /* ... */ }
    public function get_url(): ?nexo_url { /* ... */ }
    public function set_title(string $title): void { /* ... */ }
    public function get_title(): string { /* ... */ }
    public function set_context(\core\rbac\context $context): void { /* ... */ }
    public function get_context(): ?\core\rbac\context { /* ... */ }
    public function set_pagelayout(string $layout): void { /* ... */ }
    public function get_pagelayout(): string { /* ... */ }
    public function set_data(string $key, $value): void { /* ... */ }
    public function get_data(string $key, $default = null) { /* ... */ }
}
```

#### 2. Actualización de `lib/setup.php`

```php
// ✅ CORRECTO (después)
global $PAGE;
$PAGE = new \core\page_manager();
```

Ahora `$PAGE` tiene todos los métodos necesarios:

- `set_url($url)` - Establecer URL de la página
- `set_title($title)` - Establecer título
- `set_context($context)` - Establecer contexto RBAC
- `set_pagelayout($layout)` - Establecer tipo de layout
- `set_data($key, $value)` - Datos personalizados
- Y métodos `get_*()` correspondientes

### Archivos modificados

- **Nuevo:** `lib/classes/page_manager.php`
  - **Commit:** [510d39c](https://github.com/alonsoarias/NexoSupport/commit/510d39c61af4bbf6849ee812e619d98f0c66a9a3)

- **Modificado:** `lib/setup.php`
  - **Líneas:** 330-333 (nuevo PASO 10)
  - **Commit:** [0536f48](https://github.com/alonsoarias/NexoSupport/commit/0536f48a2104cef09dffa33034c7e7d52f659550)

---

## Acciones necesarias después de aplicar las correcciones

### 1. Actualizar código (Git)

```bash
git pull origin main
```

### 2. Regenerar autoloader de Composer

```bash
composer dump-autoload
```

Esto es **necesario** para que Composer reconozca la nueva clase `\core\page_manager`.

### 3. Verificar funcionamiento

Accede a:

- **Configuración general:** `http://localhost/admin/settings/`
  - Debería cargar sin errores de TypeError
  - El campo "Descripción del sitio" debería mostrarse como textarea

- **Reporte de rendimiento:** `http://localhost/report/performance/`
  - Debería cargar sin error de `set_url()`

---

## Compatibilidad

### Patrón Moodle

La clase `page_manager` sigue el patrón de Moodle para el objeto global `$PAGE`:

- **Moodle:** `$PAGE->set_url()`, `$PAGE->set_title()`, etc.
- **NexoSupport:** Mismos métodos, misma interfaz

Esto facilita la portabilidad de código y mantiene la arquitectura Frankenstyle.

### Uso en el código

```php
global $PAGE;

// Establecer URL
$url = new \core\nexo_url('/report/performance/index.php');
$PAGE->set_url($url);

// Establecer título
$PAGE->set_title('Reporte de Rendimiento');

// Establecer contexto RBAC
$context = \core\rbac\context_system::instance();
$PAGE->set_context($context);

// Establecer tipo de layout
$PAGE->set_pagelayout('report');
```

---

## Historial de cambios

| Fecha | Versión | Cambios |
|-------|---------|--------|
| 2025-11-23 | 1.1.3 | Corrección de errores TypeError y stdClass::set_url() |

---

## Contacto

Para reportar más errores o sugerencias:

- **Alonso Arias** - soporteplataformas@iser.edu.co
- **Yulian Moreno** - nexo.operativo@iser.edu.co

---

**NexoSupport** - Sistema de Gestión con Arquitectura Frankenstyle  
Instituto Superior de Educación Rural (ISER)
